### Run MCMC Analysis using jags
library(R2jags)
library(rstan)
library(rjags)
dyn.load(file, DLLpath = DLLpath, ...)
library("jagsUI", lib.loc="~/Library/R/3.5/library")
detach("package:jagsUI", unload=TRUE)
library("R2jags", lib.loc="~/Library/R/3.5/library")
library("R2WinBUGS", lib.loc="~/Library/R/3.5/library")
library("rjags", lib.loc="~/Library/R/3.5/library")
library("jagsUI", lib.loc="~/Library/R/3.5/library")
update.packages("jagsUI")
update.packages("rjags")
update.packages("r2jags")
library(R2jags)
devtools::install_url("http://sourceforge.net/projects/mcmc-jags/files/rjags/3/rjags_3-2.tar.gz",
args="--configure-args='--with-jags-include=/Users/casallas/homebrew/opt/jags/include/JAGS
--with-jags-lib=/Users/casallas/homebrew/opt/jags/lib'
"
)
devtools::install_url("https://sourceforge.net/projects/mcmc-jags/files/JAGS/4.x/Mac%20OS%20X/",
args="--configure-args='--with-jags-include=/Users/casallas/homebrew/opt/jags/include/JAGS
--with-jags-lib=/Users/casallas/homebrew/opt/jags/lib'
"
)
remove.packages("rjags", lib="~/Library/R/3.5/library")
remove.packages("jagsUI", lib="~/Library/R/3.5/library")
remove.packages("R2jags", lib="~/Library/R/3.5/library")
library("rjags", lib.loc="~/Library/R/3.5/library")
remove.packages("rjags", lib="~/Library/R/3.5/library")
library("R2WinBUGS", lib.loc="~/Library/R/3.5/library")
library("R2jags", lib.loc="~/Library/R/3.5/library")
install.packages("rjags")
library("rjags", lib.loc="~/Library/R/3.5/library")
remove.packages("rjags", lib="~/Library/R/3.5/library")
remove.packages("R2jags", lib="~/Library/R/3.5/library")
install.packages("jagsUI")
library(jagsUI)
library("jagsUI", lib.loc="~/Library/R/3.5/library")
install.packages("~/Downloads/JAGS-4.3.0.dmg", repos = NULL)
library("jagsUI", lib.loc="~/Library/R/3.5/library")
detach("package:jagsUI", unload=TRUE)
remove.packages("jagsUI", lib="~/Library/R/3.5/library")
library("rjags", lib.loc="~/Library/R/3.5/library")
devtools::install_url("http://sourceforge.net/projects/mcmc-jags/files/rjags/4/rjags_4-4.tar.gz")
devtools::install_url("http://sourceforge.net/projects/mcmc-jags/files/rjags/4/rjags_4-4.tar.gz")
library(rjags)
devtools::install_url("http://sourceforge.net/projects/mcmc-jags/files/rjags/4/rjags_4-4.tar.gz",)
remove.packages("rjags", lib="~/Library/R/3.5/library")
library(geosphere)
daylength(45,59)
daylength(45,59+61)
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
#or from laptop:
#setwd("/Users/aileneettinger/Documents/GitHub/fishphen")
#Read in the files
d1<-read.csv("data/WDFW_fromkk/PugetSound_1987_1989-1993_SalmonCatch-ReleaseData.csv", header=TRUE)
head(d1)
unique(X.OtherSpCaught)
unique(d1$X.OtherSpCaught)
unique(d1$SpeciesName)
unique(d1$OtherSpCode)
#1994-1996
d2<-read.csv("data/WDFW_fromkk/PugetSound_1994-1996_SalmonCatch-ReleaseData.csv", header=TRUE)
head(d2)
length(colnames(d1))
length(colnames(d2))
d1$Rel.Sps.Code<-NA
d1$X.Rel<-NA
length(colnames(d1))
unique(d2$X.OtherSpCaught)
unique(d2$SpeciesName)
unique(d2$OtherSpCode)#NA 101 102 103 104 105 106 123 107 108
#1994-1996
d3<-read.csv("data/WDFW_fromkk/PugetSound_1997-2000_SalmonCatch-ReleaseData.csv", header=TRUE)
head(d3)
colnames(d2)
colnames(d3)
unique(d2$X.Rel)
unique(d1$X.Rel)
colnames(d1)
unique(d3$SalmonReleaseSpsName)
unique(d3$X.OtherSpCaught)
unique(d3$SpeciesName)
unique(d3$OtherSpCode)#NA 101 102 103 104 105 106 123 107 108
#2014
d5<-read.csv("data/WDFW_fromkk/PugetSound_2014SalmonCatch-ReleaseData.csv", header=TRUE)
#2015-2017April
head(d5)
d6<-read.csv("data/WDFW_fromkk/PugetSound_2015-2017AprSalmonCatch-ReleaseData.csv", header=TRUE)
head(d6)
#2017May-2018dec
d7<-read.csv("data/WDFW_fromkk/PugetSound_2017May-2018SalmonCatch-ReleaseData.csv", header=TRUE)
head(d7)
#Only use fishing areas that have atleast 4 years with >20 observations:
#Look at some basic stats about orca observations
#Started with orca_dataprep_occmodel.R code
#4 February 2019
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
#or from laptop:
#setwd("/Users/aileneettinger/Documents/GitHub/fishphen")
# Load libraries
library(dplyr)
library(mgcv)
library(scales)
# 1. Get the data
d <- read.csv("data/AppendixII.csv")
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/clean_orca.R")
#Create a new column that combines Pod and Likely Pod columna and removes spaces
d$Pod.cl<-d$Pod
#Always use Likely Pod column, when it is not blank:
d$Pod.cl[d$LikelyPod!="" & d$LikelyPod!=" "]<-d$LikelyPod[d$LikelyPod!="" & d$LikelyPod!=" "]
#perhaps also stick with Pod when LikelyPod has a "?" grep("?",d$LikelyPod,)
#only using fishing areas in Salish Sea
d<-d[d$FishArea %in% c("01","02","03","04","05","06","07","09","10","11","12","13","81","82","19C","18C","29C","20C"),]#not sure where 17, 18, 19, 20, 28, 29 are...need to find out. also, where is 42583,42584
#remove sites with no fishing area:
d<-d[!d$FishArea %in% c(""),]
#Assign region, based on fishing area:
d$region<-"ps"
d$region[d$FishArea=="07"|d$FishArea=="06"|d$FishArea=="05"|d$FishArea=="04"|d$FishArea=="19C"|d$FishArea== "18C"|d$FishArea=="20C"]<-"uss"
d$region[d$FishArea=="01"|d$FishArea=="02"|d$FishArea=="03"]<-"oc"#outer coast
#Add week and day of year (day)
d$day<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"),format= "%j")
d$week<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"), format = "%V")#new weeks start on mondays
d<-d[-which(is.na(d$day)),]
#Add a column for presences (1/0) for each pod, for Ts, and for SRKWs
d$J<-0
d$J[grep("J",d$Pod.cl)]<- 1
d$K<-0
d$K[grep("K",d$Pod.cl)]<- 1
d$L<-0
d$L[grep("L",d$Pod.cl)]<- 1
d$SRKW<-0
d$SRKW[grep("SR",d$Pod.cl)]<- 1
d$SRKW[d$J==1|d$K==1|d$L==1]<- 1
d$Orcas<-1
d$Trans<-0
d$Trans[grep("T",d$Pod.cl)]<- 1
#only data starting with 1976 (following Olson et al)
d<-d[d$Year>1975,]
# Add a column that combines :
#1) day, year, and region;
#2) day, year, and fishing area
#3) week, year, and region;
#4) week, year, and fishing are;
#to use to total up observations for later analyses
d$yrdayregion<-paste(d$Year, d$day,d$region,sep="_")
d$yrwkregion<-paste(d$Year, d$week,d$region,sep="_")
d$yrdayfa<-paste(d$Year, d$day,d$FishArea,sep="_")
d$yrwkfa<-paste(d$Year, d$week,d$FishArea,sep="_")
d$yrregion<-paste(d$Year,d$region,sep="_")
d$yrfa<-paste(d$Year, d$FishArea,sep="_")
#Plot a bunch of different things:
#1. Plot the total number of orca observations per year in each region since 1978
#a. All pods together
#b .Each pod separately
obs = aggregate(Orcas ~yrregion, data = d,sum)
js = aggregate(J ~yrregion, data = d,sum)
ks = aggregate(K~yrregion, data = d,sum)
ls = aggregate(L~yrregion, data = d,sum)
srs = aggregate(SRKW~yrregion, data = d,sum)
orcasum<-cbind(js,ks[,2],ls[,2],srs[,2],obs[2])
colnames(orcasum)[2:6]<-c("Jobs","Kobs","Lobs","AllSRobs","AllOrcas")
orcasum$year<-substr(orcasum$yrregion,1,4)
orcasum$region<-substr(orcasum$yrregion,6,nchar(orcasum$yrregion))
obs.days = aggregate(Orcas ~yrdayregion, data = d,sum)
js.days = aggregate(J ~yrdayregion, data = d,sum)
ks.days = aggregate(K~yrdayregion, data = d,sum)
ls.days = aggregate(L~yrdayregion, data = d,sum)
srs.days = aggregate(SRKW~yrdayregion, data = d,sum)
orcasum.days<-cbind(js.days,ks.days[,2],ls.days[,2],srs.days[,2],obs.days[2])
colnames(orcasum.days)[2:6]<-c("Jobs","Kobs","Lobs","AllSRobs","AllOrcas")
orcasum.days$year<-substr(orcasum.days$yrdayregion,1,4)
orcasum.days$day<-substr(orcasum.days$yrdayregion,6,8)
orcasum.days$region<-substr(orcasum.days$yrdayregion,10,nchar(orcasum.days$yrdayregion))
orcasum.days$Jpres<-orcasum.days$Jobs
orcasum.days$Jpres[orcasum.days$Jobs>0]<-1
orcasum.days$Kpres<-orcasum.days$Kobs
orcasum.days$Kpres[orcasum.days$Kobs>0]<-1
orcasum.days$Lpres<-orcasum.days$Lobs
orcasum.days$Lpres[orcasum.days$Lobs>0]<-1
orcasum.days$AllSRpres<-orcasum.days$AllSRobs
orcasum.days$AllSRpres[orcasum.days$AllSRobs>0]<-1
#summarize whale days per year by region
wdays<-as.data.frame(tapply(orcasum.days$AllSRpres,list(orcasum.days$year,orcasum.days$region),sum))
dim(wdays)#40 years
colMeans(wdays[1:20,], na.rm=TRUE)
wdays.J<-as.data.frame(tapply(orcasum.days$Jpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.K<-as.data.frame(tapply(orcasum.days$Kpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.L<-as.data.frame(tapply(orcasum.days$Lpres,list(orcasum.days$year,orcasum.days$region),sum))
#Plots observed or not, by doy and year
#yaxis is year
#xaxis is doy
#do for 3 regions
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
for(p in 1:length(podcols)){
quartz(width=16,height=6)
par(omi=c(.5,2,.5,.5), mfrow=c(1,3))
colnum<-which(colnames(orcasum.days)==podcols[p])
regions=unique(orcasum.days$region)
for(r in regions){
regdat<-orcasum.days[orcasum.days$region==r,]
years = unique(orcasum.days$year)
plot(0, type = 'n', las=1, xlim=c(1,366),ylim=c(min(as.numeric(years)),max(as.numeric(years))),ylab="",xlab="Day of year", main=paste(r), cex.axis=1.1, cex.lab=1.3)
for(y in years){
yrdat = regdat[regdat$year==y,]
days = yrdat$day[yrdat[,colnum]==1]
points(x=days,y=rep(y,length=length(days)), pch=21,bg="gray", cex=1.3)
#lines(x=days,y=rep(y,length=length(days)), lwd=2)
}
if(r=="uss"){mtext(paste(pods[p]), side=3,line=3, adj=0.5)}
if(r=="ps"){mtext("Year", side=2,line=4, adj=0.5)}
}
}
#summary of the number of days whales were observed in each region, by year:
pres<-tapply(orcasum.days$AllSRpres,list(orcasum.days$region, orcasum.days$year),sum)
#summary of the number of days whales with rows of data (observed or not) in each region, by year:
totobs<-tapply(orcasum.days$AllSRpres,list(orcasum.days$region, orcasum.days$year),length)
prob<-pres/totobs
#summary of the number of days whales were observed in each region, across all years:
pres.doy<-tapply(orcasum.days$AllSRpres,list(orcasum.days$region, orcasum.days$day),sum)
#summary of the number of days whales with rows of data (observed or not) in each region, across all tears:
totobs.doy<-tapply(orcasum.days$AllSRpres,list(orcasum.days$region, orcasum.days$day),length)
prob.doy<-pres.doy/totobs.doy
quartz()
par(mfrow=c(2,1))
plot(colnames(prob.doy),prob.doy[3,], type="l", ylab="Probability of obs.",xlab="DOY", main="USS")
plot(colnames(prob.doy),prob.doy[2,], type="l", ylab="Probability of obs.",xlab="DOY", main="PS")
#Add days after sept 30:
orcasum.days$daysaftsept30<-NA
orcasum.days$day<-as.numeric(orcasum.days$day)
orcasum.days$year<-as.numeric(orcasum.days$year)
orcasum.days$daysaftsept30[which(orcasum.days$day>273 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>273 & orcasum.days$day<367)]-273
orcasum.days$daysaftsept30[which(orcasum.days$day<274)]<-orcasum.days$day[which(orcasum.days$day<274)]+93#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear<-orcasum.days$year
orcasum.days$orcayear[which(orcasum.days$day>273)]<-orcasum.days$year[which(orcasum.days$day>273)]+1
head(orcasum.days)
tail(orcasum.days)
orcasum.days$daysaftsept30<-NA
orcasum.days$day<-as.numeric(orcasum.days$day)
orcasum.days$year<-as.numeric(orcasum.days$year)
orcasum.days$daysaftsept30[which(orcasum.days$day>273 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>273 & orcasum.days$day<367)]-273
orcasum.days$daysaftsept30[which(orcasum.days$day<274)]<-orcasum.days$day[which(orcasum.days$day<274)]+93#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear<-orcasum.days$year
orcasum.days$orcayear[which(orcasum.days$day>273)]<-orcasum.days$year[which(orcasum.days$day>273)]+1
#Add days after June 30:
orcasum.days$daysaftjun30[which(orcasum.days$day>179 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>179 & orcasum.days$day<367)]-179
orcasum.days$daysaftjun30[which(orcasum.days$day<180)]<-orcasum.days$day[which(orcasum.days$day<180)]+187#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear2<-orcasum.days$year
orcasum.days$orcayear[which(orcasum.days$day>179)]<-orcasum.days$year[which(orcasum.days$day>179)]+1
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
tail(orcasum.days)
orcasum.days$daysaftsept30[which(orcasum.days$day>273 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>273 & orcasum.days$day<367)]-273
orcasum.days$daysaftsept30[which(orcasum.days$day<274)]<-orcasum.days$day[which(orcasum.days$day<274)]+93#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear<-orcasum.days$year
orcasum.days$orcayear[which(orcasum.days$day>273)]<-orcasum.days$year[which(orcasum.days$day>273)]+1
#Add days after June 30:
orcasum.days$daysaftjun30[which(orcasum.days$day>179 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>179 & orcasum.days$day<367)]-179
orcasum.days$daysaftjun30[which(orcasum.days$day<180)]<-orcasum.days$day[which(orcasum.days$day<180)]+187#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear2<-orcasum.days$year
orcasum.days$orcayear2[which(orcasum.days$day>179)]<-orcasum.days$year[which(orcasum.days$day>179)]+1
tail(orcasum.days)
regions=unique(orcasum.days$region)
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
years<-unique(orcasum.days$year)
pods.all<-c()
regions.all<-c()
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
meanest.all<-c()
firstest.sept30.all<-c()
lastest.sept30.all<-c()
meanest.sept30.all<-c()
firstest.jun30.all<-c()
lastest.jun30.all<-c()
meanest.jun30.all<-c()
for(p in 1:length(podcols)){
colnum<-which(colnames(orcasum.days)==podcols[p])
for(r in 1:length(regions)){
regdat<-orcasum.days[orcasum.days$region==regions[r],]
if (regions[r]=="ps"){
regdat<-regdat[as.numeric(regdat$day)>273,]#look at data only after Sept 30 for PS
}
if (regions[r]=="uss"){
regdat<-regdat[as.numeric(regdat$day)<273,]#look at data before Sept 30 for USS
regdat<-regdat[as.numeric(regdat$day)>121,]#look at data after MAy 1 for USS
}
for(y in 1:length(years)){
yrdat<-regdat[regdat$year==years[y],]
pods.all<-c(pods.all,pods[p])
regions.all<-c(regions.all,regions[r])
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat[,colnum]==1]))
firstest.all<-c(firstest.all,min(yrdat$day[yrdat[,colnum]==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat[,colnum]==1], na.rm=TRUE))
meanest.all<-c(meanest.all,mean(as.numeric(yrdat$day[yrdat[,colnum]==1]), na.rm=TRUE))
orcayrdat<-regdat[regdat$orcayear==years[y],]
orcayrdat2<-regdat[regdat$orcayear2==years[y],]
firstest.sept30.all<-c(firstest.sept30.all,min(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1], na.rm=TRUE))
lastest.sept30.all<-c(lastest.sept30.all,max(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1], na.rm=TRUE))
meanest.sept30.all<-c(meanest.sept30.all,mean(as.numeric(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1]), na.rm=TRUE))
firstest.jun30.all<-c(firstest.jun30.all,min(orcayrdat2$daysaftjun30[orcayrdat2[,colnum]==1], na.rm=TRUE))
lastest.jun30.all<-c(lastest.jun30.all,max(orcayrdat2$daysaftjun30[orcayrdat2[,colnum]==1], na.rm=TRUE))
meanest.jun30.all<-c(meanest.jun30.all,mean(as.numeric(orcayrdat2$daysaftjun30[orcayrdat2[,colnum]==1]), na.rm=TRUE))
}
}
}
df <- as.data.frame(cbind(pods.all,regions.all,years.all,nobs.all,firstest.all,lastest.all,meanest.all,firstest.sept30.all,lastest.sept30.all,meanest.sept30.all,firstest.jun30.all,lastest.jun30.all,meanest.jun30.all))
head(df)
colnames(df)<-c("pod","region","year","nobs","firstest","lastest","meanest","firstest.sept30","lastest.sept30","meanest.sept30","firstest.jun30","lastest.jun30","meanest.jun30")
head(df)
podcols<-c("AllSRpres")#just do for all SRs for now
pods<-c("SRs")
years<-unique(orcasum.days$year)
regions=unique(orcasum.days$region)
podcols<-c("AllSRpres")#just do for all SRs for now
pods<-c("SRs")
stseas<-c("1jul","1aug","1sep","1oct")
enseas<-c("31dec","31jan","28feb","31mar")
years<-unique(orcasum.days$orcayear2)#use July 1 as start of orca year, as this will encompass min start date window that i want to try
head(regdat)
styr.date<-paste("2019","Jul","1", sep="-")
styr.date
styr.date<-paste("2019","Jul","1", sep="-")
styr.doy<-as.Date(styr.date,format = "%j",origin=styr.date)
styr.doy
styr.date
styr.doy<-as.Date(styr.date,format = "%j",origin=as.Date(styr.date))
styr.doy
styr.doy<-strptime(styr.date,format = "%j",origin=as.Date(styr.date))
styr.doy<-strptime(styr.date,format = "%j")
styr.doy
styr.date
styr.date<-as.Date(paste("2019","Jul","1", sep="-"))
styr.date<-as.Date(paste("2019","07","1", sep="-"))
styr.date
styr.doy<-strptime(styr.date,format = "%j")
styr.doy
d$day<-strftime(styr.date,format= "%j")
d$day
styr.doy<-strftime(styr.date,format= "%j")
styr.doy
head(regdat)
stseas<-c("07","08","09","10")
enseas<-c("12","1","2","03")
stseas<-c("07","08","09","10")
t=1
styr.date<-as.Date(paste("2019",stseas[t],"1", sep="-"))
styr.date
styr.doy<-strptime(styr.date,format = "%j")
styr.doy
