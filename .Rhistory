peakest<-c(y,pktim,pod[p],region[i])
allpeakest<-rbind(peakest,allpeakest)
#dev.off()
}
}
if(region[i]=="uss"){
dat<-d[d$Year==y,]
dat<-dat[dat$Month>4 & dat$Month<10,]#for upper salish sea, look at summer phenology- may-oct
}
if(region[i]=="ps"){
dat<-d[d$orcayear==y,]
dat<-dat[dat$Month>=10 |dat$Month<3,]#for puget, look at winter phenology- oct-feb
}
dat<-dat[dat$region==region[i],]
dat$pod.obs<-dat[,which(colnames(dat)==pod[p])]
#aggregate by week and doy
if(region[i]=="uss"){
pod.wk = aggregate(pod.obs~ week, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$week)
pod.doy = aggregate(pod.obs~ doy, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy)
pod.doy<-pod.doy[order(pod.doy$doy),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$doy)
}
if(region[i]=="ps"){
pod.wk = aggregate(pod.obs~ weeksaftsept30, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$weeksaftsept30)
pod.doy = aggregate(pod.obs~ daysaftsept30, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy, by="daysaftsept30")
pod.doy<-pod.doy[order(pod.doy$daysaftsept30),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$daysaftsept30)
}
#pod.wk$pod.obs[which(is.na(pod.wk$pod.obs))]<-0
podobs<-pod.doy$pod.obs
if(dim(dat)[1]>10){
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
g = gam(podobs ~ s(week))
#g.notlog = gam(podobs ~ s(week,bs="cc") + offset(pod.wk$observations))#nonsensical
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(doy,exp(g$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,max(podobs)))
lines(spline(doy,log(podobs+1),n=length(week)), col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(doy,podobs, pch=21,bg="gray" )
if(region[i]=="uss"){axis(1,labels=c("Jan","Mar","May","Jul","Sep","Nov"), at=c(1,9,18,27,35,44))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
pk<-max(g$fitted.values)
pktim<-as.numeric(doy[which.max(g$fitted.values)])
abline(v=pktim,col="red")
#pk.wk<-max(g$fitted.values)
#pkweek<-as.numeric(week[which.max(g$fitted.values)])
#abline(v=pkweek,col="red")
peakest<-c(y,pktim,pod[p],region[i])
allpeakest<-rbind(peakest,allpeakest)
#dev.off()
}
if(region[i]=="ps"){
pod.wk = aggregate(pod.obs~ weeksaftsept30, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$weeksaftsept30)
pod.doy = aggregate(pod.obs~ daysaftsept30, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy, by="daysaftsept30")
pod.doy<-pod.doy[order(pod.doy$daysaftsept30),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$daysaftsept30)
}
#pod.wk$pod.obs[which(is.na(pod.wk$pod.obs))]<-0
podobs<-pod.doy$pod.obs
if(dim(dat)[1]>10){
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
g = gam(podobs ~ s(doy))} else(next)
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(doy,exp(g$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,max(podobs)))
lines(spline(doy,log(podobs+1),n=length(week)), col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(doy,podobs, pch=21,bg="gray" )
if(region[i]=="uss"){axis(1,labels=c("Jan","Mar","May","Jul","Sep","Nov"), at=c(1,9,18,27,35,44))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
pk<-max(g$fitted.values)
pktim<-as.numeric(doy[which.max(g$fitted.values)])
abline(v=pktim,col="red")
peakest
for(y in years){
if(region[i]=="uss"){
dat<-d[d$Year==y,]
dat<-dat[dat$Month>4 & dat$Month<10,]#for upper salish sea, look at summer phenology- may-oct
}
if(region[i]=="ps"){
dat<-d[d$orcayear==y,]
dat<-dat[dat$Month>=10 |dat$Month<3,]#for puget, look at winter phenology- oct-feb
}
#get effort estimate (total observations per day, across all salish sea and all pods)
#if(region[i]=="uss"){
#  obs = aggregate(observations ~week, data = dat,sum)
# obs.doy = aggregate(observations ~doy, data = dat,sum)}
#if(region[i]=="ps"){
#  obs = aggregate(observations ~weeksaftsept30, data = dat,sum)
#  obs.doy = aggregate(observations ~daysaftsept30, data = dat,sum)}
dat<-dat[dat$region==region[i],]
dat$pod.obs<-dat[,which(colnames(dat)==pod[p])]
#aggregate by week and doy
if(region[i]=="uss"){
pod.wk = aggregate(pod.obs~ week, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$week)
pod.doy = aggregate(pod.obs~ doy, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy)
pod.doy<-pod.doy[order(pod.doy$doy),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$doy)
}
if(region[i]=="ps"){
pod.wk = aggregate(pod.obs~ weeksaftsept30, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$weeksaftsept30)
pod.doy = aggregate(pod.obs~ daysaftsept30, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy, by="daysaftsept30")
pod.doy<-pod.doy[order(pod.doy$daysaftsept30),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$daysaftsept30)
}
#pod.wk$pod.obs[which(is.na(pod.wk$pod.obs))]<-0
podobs<-pod.doy$pod.obs
if(dim(dat)[1]>10){
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
g = gam(podobs ~ s(doy))} else(next)
#g.notlog = gam(podobs ~ s(week,bs="cc") + offset(pod.wk$observations))#nonsensical
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(doy,exp(g$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,max(podobs)))
lines(spline(doy,log(podobs+1),n=length(week)), col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(doy,podobs, pch=21,bg="gray" )
if(region[i]=="uss"){axis(1,labels=c("Jan","Mar","May","Jul","Sep","Nov"), at=c(1,9,18,27,35,44))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
pk<-max(g$fitted.values)
pktim<-as.numeric(doy[which.max(g$fitted.values)])
abline(v=pktim,col="red")
#pk.wk<-max(g$fitted.values)
#pkweek<-as.numeric(week[which.max(g$fitted.values)])
#abline(v=pkweek,col="red")
peakest<-c(y,pktim,pod[p],region[i])
allpeakest<-rbind(peakest,allpeakest)
#dev.off()
}
head(dat)
unique(dat$SightDate)
unique(dat$SRKW)
#try binomial gam
gbin<-gam(SRKW~s(daysaftsept30), data=dat)
gbin$fitted.values
plogis(gbin$fitted.values)
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(dat$daysaftsept30,plogis(gbin$fitted.values), type="l", xaxt="n",ylab = "Probability of observing orcas", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,1))
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(dat$daysaftsept30,dat$SRKW, pch=21,bg="gray" )
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
g = gam(podobs ~ s(doy),family="binomial")
podobs
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
#g = gam(podobs ~ s(doy))
gbin<-gam(SRKW~s(daysaftsept30), data=dat, family="binomnial")
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
#g = gam(podobs ~ s(doy))
gbin<-gam(SRKW~s(daysaftsept30), data=dat, family="binomial")
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(dat$daysaftsept30,plogis(gbin$fitted.values), type="l", xaxt="n",ylab = "Probability of observing orcas", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,1))
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(dat$daysaftsept30,dat$SRKW, pch=21,bg="gray" )
mod = glm(SRKW~daysaftsept30, data=dat, family="binomial")
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(dat$daysaftsept30,plogis(gbin$fitted.values), type="l", xaxt="n",ylab = "Probability of observing orcas", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,1))
lines(dat$daysaftsept30,mod$fitted.values, col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(dat$daysaftsept30,dat$SRKW, pch=21,bg="gray" )
points(dat$daysaftsept30,mod$fitted.values, col="blue")
#for each year, region and pod, estimate peak day of observed activity
allpeakest<-c()
for(y in years){
if(region[i]=="uss"){
dat<-d[d$Year==y,]
dat<-dat[dat$Month>4 & dat$Month<10,]#for upper salish sea, look at summer phenology- may-oct
}
if(region[i]=="ps"){
dat<-d[d$orcayear==y,]
dat<-dat[dat$Month>=10 |dat$Month<3,]#for puget, look at winter phenology- oct-feb
}
#get effort estimate (total observations per day, across all salish sea and all pods)
#if(region[i]=="uss"){
#  obs = aggregate(observations ~week, data = dat,sum)
# obs.doy = aggregate(observations ~doy, data = dat,sum)}
#if(region[i]=="ps"){
#  obs = aggregate(observations ~weeksaftsept30, data = dat,sum)
#  obs.doy = aggregate(observations ~daysaftsept30, data = dat,sum)}
dat<-dat[dat$region==region[i],]
dat$pod.obs<-dat[,which(colnames(dat)==pod[p])]
#aggregate by week and doy
if(region[i]=="uss"){
pod.wk = aggregate(pod.obs~ week, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$week)
pod.doy = aggregate(pod.obs~ doy, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy)
pod.doy<-pod.doy[order(pod.doy$doy),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$doy)
}
if(region[i]=="ps"){
pod.wk = aggregate(pod.obs~ weeksaftsept30, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$weeksaftsept30)
pod.doy = aggregate(pod.obs~ daysaftsept30, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy, by="daysaftsept30")
pod.doy<-pod.doy[order(pod.doy$daysaftsept30),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$daysaftsept30)
}
#try binomial gam
if(dim(dat)[1]>10){
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
#g = gam(podobs ~ s(doy))
gbin<-gam(SRKW~s(daysaftsept30), data=dat, family="binomial")
#pod.wk$pod.obs[which(is.na(pod.wk$pod.obs))]<-0
podobs<-pod.doy$pod.obs
mod = glm(SRKW~daysaftsept30, data=dat, family="binomial")
} else(next)
#g.notlog = gam(podobs ~ s(week,bs="cc") + offset(pod.wk$observations))#nonsensical
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(dat$daysaftsept30,plogis(gbin$fitted.values), type="l", xaxt="n",ylab = "Probability of observing orcas", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,1))
lines(dat$daysaftsept30,mod$fitted.values, col="blue")
#points(dat$daysaftsept30,mod$fitted.values, col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(dat$daysaftsept30,dat$SRKW, pch=21,bg="gray" )
if(region[i]=="uss"){axis(1,labels=c("Jan","Mar","May","Jul","Sep","Nov"), at=c(1,9,18,27,35,44))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
pk<-max(gbin$fitted.values)
pktim<-as.numeric(doy[which.max(gbin$fitted.values)])
pk.glm<-max(mod$fitted.values)
pktim.glm<-as.numeric(doy[which.max(mod$fitted.values)])
abline(v=pktim,col="red")
abline(v=pktim.glm,col="blue")
#pk.wk<-max(g$fitted.values)
#pkweek<-as.numeric(week[which.max(g$fitted.values)])
#abline(v=pkweek,col="red")
peakest<-c(y,pktim,pktime.glm,pod[p],region[i])
allpeakest<-rbind(peakest,allpeakest)
#dev.off()
}
for(y in years){
if(region[i]=="uss"){
dat<-d[d$Year==y,]
dat<-dat[dat$Month>4 & dat$Month<10,]#for upper salish sea, look at summer phenology- may-oct
}
if(region[i]=="ps"){
dat<-d[d$orcayear==y,]
dat<-dat[dat$Month>=10 |dat$Month<3,]#for puget, look at winter phenology- oct-feb
}
#get effort estimate (total observations per day, across all salish sea and all pods)
#if(region[i]=="uss"){
#  obs = aggregate(observations ~week, data = dat,sum)
# obs.doy = aggregate(observations ~doy, data = dat,sum)}
#if(region[i]=="ps"){
#  obs = aggregate(observations ~weeksaftsept30, data = dat,sum)
#  obs.doy = aggregate(observations ~daysaftsept30, data = dat,sum)}
dat<-dat[dat$region==region[i],]
dat$pod.obs<-dat[,which(colnames(dat)==pod[p])]
#aggregate by week and doy
if(region[i]=="uss"){
pod.wk = aggregate(pod.obs~ week, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$week)
pod.doy = aggregate(pod.obs~ doy, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy)
pod.doy<-pod.doy[order(pod.doy$doy),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$doy)
}
if(region[i]=="ps"){
pod.wk = aggregate(pod.obs~ weeksaftsept30, data = dat,sum)
#pod.wk<-full_join(pod.wk,obs)
pod.wk<-pod.wk[order(pod.wk$week),]
week = as.numeric(pod.wk$weeksaftsept30)
pod.doy = aggregate(pod.obs~ daysaftsept30, data = dat,sum)
#pod.doy<-left_join(pod.doy,obs.doy, by="daysaftsept30")
pod.doy<-pod.doy[order(pod.doy$daysaftsept30),]
#pod.doy$pod.obs[which(is.na(pod.doy$pod.obs))]<-0
doy = as.numeric(pod.doy$daysaftsept30)
}
#try binomial gam
if(dim(dat)[1]>10){
#g = gam(log(podobs+1) ~ s(doy) + offset(log(pod.doy$observations)))} else(next)
#g = gam(podobs ~ s(doy))
gbin<-gam(SRKW~s(daysaftsept30), data=dat, family="binomial")
#pod.wk$pod.obs[which(is.na(pod.wk$pod.obs))]<-0
podobs<-pod.doy$pod.obs
mod = glm(SRKW~daysaftsept30, data=dat, family="binomial")
} else(next)
#g.notlog = gam(podobs ~ s(week,bs="cc") + offset(pod.wk$observations))#nonsensical
#pdf(file.path(figpath, paste(pod[p],y,region[i],"tempforecast.pdf", sep="_")), width = 9, height = 6)
quartz()
plot(dat$daysaftsept30,plogis(gbin$fitted.values), type="l", xaxt="n",ylab = "Probability of observing orcas", xlab="Month", main=paste(pod[p],region[i],y,sep=" "), ylim=c(0,1))
lines(dat$daysaftsept30,mod$fitted.values, col="blue")
#points(dat$daysaftsept30,mod$fitted.values, col="blue")
#plot(week,exp(g.no.off$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
#plot(week,exp(g.notlog$fitted.values), type="l", xaxt="n",ylab = "Orca observations", xlab="Month", main=paste(pod[p],region[i],y,sep=" "))
points(dat$daysaftsept30,dat$SRKW, pch=21,bg="gray" )
if(region[i]=="uss"){axis(1,labels=c("Jan","Mar","May","Jul","Sep","Nov"), at=c(1,9,18,27,35,44))}
if(region[i]=="ps"){axis(1,labels=c("1Sep","1Nov","1Jan"), at=c(1,62,123))}
pk<-max(gbin$fitted.values)
pktim<-as.numeric(doy[which.max(gbin$fitted.values)])
pk.glm<-max(mod$fitted.values)
pktim.glm<-as.numeric(doy[which.max(mod$fitted.values)])
abline(v=pktim,col="red")
abline(v=pktim.glm,col="blue")
#pk.wk<-max(g$fitted.values)
#pkweek<-as.numeric(week[which.max(g$fitted.values)])
#abline(v=pkweek,col="red")
peakest<-c(y,pktim,pktim.glm,pod[p],region[i])
allpeakest<-rbind(peakest,allpeakest)
#dev.off()
}
y
allpeakest<-as.data.frame(allpeakest)
colnames(allpeakest)<-c("year","pkweek","pod","region")
quartz()
plot(as.numeric(allpeakest$year),as.numeric(allpeakest$pkweek), type="p",pch=21,bg="gray")
allpeakest
peakest
colnames(allpeakest)<-c("year","pkdoy.gam","pkdoy.glm","pod","region")
allpeakest<-as.data.frame(allpeakest)
colnames(allpeakest)<-c("year","pkdoy.gam","pkdoy.glm","pod","region")
quartz()
plot(as.numeric(allpeakest$year),as.numeric(allpeakest$pdoy.gam), type="p",pch=21,bg="gray")
plot(as.numeric(allpeakest$year),as.numeric(allpeakest$pkdoy.gam), type="p",pch=21,bg="gray")
points(as.numeric(allpeakest$year),as.numeric(allpeakest$pkdoy.glm))
# (Study of phenology by flexible estimation and modeling of seasonal detectability peaks)
# Ailene Ettinger, ailene.ettinger@noaa.gov
# (modifed from code of  Nicolas Strebel, nicolas_strebel@gmx.ch)
# Start Date:	November 27, 2018
# Title:	orca_run_occ_model
##################################################################
#-----------------------------------------------------------------
# Codes prepare data for jags and run the analysis
#-----------------------------------------------------------------
# Set working directory
setwd("~/Documents/GitHub/fishphen")
# Load libraries
library(R2jags)
# Specify model in BUGS language
sink("analyses/splinesSiteOcc S4.txt")
# Load libraries
library(R2jags)
install.packages("R2jags")
# Load libraries
library(R2jags)
# Specify model in BUGS language
sink("analyses/splinesSiteOcc S4.txt")
cat("
model {
### Define seasonal and annual patterns in detectability
for (m in 1:nyear) {
for (i in 1:n) {
logit(p[m,i]) <- lp[m,i]
lp[m,i] <- mfe[m,i]+mre[m,i]
mfe[m,i] <- a[m]*X[i,1]+b[m]*X[i,2]+c[m]*X[i,3]
mre[m,i]<-sum(n.mre[m,i,1:nknots])
for (k in 1:nknots) {
n.mre[m,i,k]<-b.k[m,k]*Z[i,k]
}
}
### Random regression coefficients corresponding to the truncated polynomial functions
for (k in 1:nknots) {
b.k[m,k] ~ dnorm(0,taub)
}
### Fixed regression coefficients corresponding to the 'plus' functions
a[m] ~ dnorm(0,0.01)
b[m] ~ dnorm(0,0.01)
c[m] ~ dnorm(0,0.01)
}
### precision for random regression coefficients corresponding to the truncated polynomial functions
taub~dgamma(1.0E-6,1.0E-6)
# Specify priors
for (k in 1:nyear) {
psi[k] ~ dunif(0, 1)
}
# Ecological submodel: Define state conditional on parameters
for (i in 1:nsite){
for (k in 1:nyear){
z[i,k] ~ dbern(psi[k])
}
}
# Observation model
for (i in 1:nobs){
muy[site[i],survey[i],year[i]] <- z[site[i],year[i]]*p[year[i],survey[i]]
y[i] ~ dbin(muy[site[i],survey[i],year[i]], nrep[i])
}
}
",fill = TRUE)
sink()
### Read observation data from focal pod (created in orca_dataprep_occmodel.R)
dat<-read.csv("analyses/output/j_dat.csv",header=T)
#choose 1 season to run on (should be only 1 peak in each of these seasons...)
dat<-dat[dat$season==2,]
### The following procedure is based on the models presented in Crainiceanu et al. 2005 and in Gimenez et al. 2006
# Degree of splines
degree <- 2
# Orca analysis: occupancy models
# Started November 1327, 2018
# by Ailene Ettinger ailene.ettinger@noo.gov
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
# Load libraries
# 1. Get the data
d <- read.csv("data/AppendixII.csv")
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/clean_orca.R")
#Create a new column that combines Pod and Likely Pod columna and removes spaces
d$Pod.cl<-d$Pod
#Always use Likely Pod column, when it is not blank:
d$Pod.cl[d$LikelyPod!="" & d$LikelyPod!=" "]<-d$LikelyPod[d$LikelyPod!="" & d$LikelyPod!=" "]
#perhaps also stick with Pod when LikelyPod has a "?" grep("?",d$LikelyPod,)
#remove non-orca data
#d<-d[d$Pod.cl=="HB?"|d$Pod.cl=="Not Orcas",]
#only using fishing areas in Washington's Salish Sea
d<-d[d$FishArea %in% c("01","02","03","04","05","06","07","09","10","11","12","13","81","82"),]#not sure where 17, 18, 19, 20, 28, 29 are...need to find out. also, where is 42583,42584
#Only use fishing areas that have atleast 4 years with >20 observations:
#11 fishing areas with >5
# 8 fishing areas with >10
# 8 fishing areas with >20
tab.fa.yr<-table(d$FishArea,d$Year)
tab.fa.yr[tab.fa.yr < 20] <- 0
tab.fa.yr[tab.fa.yr >= 20] <- 1
sites.touse<-rownames(tab.fa.yr)[rowSums(tab.fa.yr)>4]
d<-d[d$FishArea %in% c(sites.touse),]
###Need to then select only the fishing areas that are 1 in tab.fa.yr
#Add week and day of year (day)
d$day<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"),format= "%j")
d$week<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"), format = "%V")#new weeks start on mondays
#Add a column for presences (1/0) for each pod, for Ts, and for SRKWs
d$J<-0
d$J[grep("J",d$Pod.cl)]<- 1
d$K<-0
d$K[grep("K",d$Pod.cl)]<- 1
d$L<-0
d$L[grep("L",d$Pod.cl)]<- 1
d$SRKW<-0
d$SRKW[grep("SR",d$Pod.cl)]<- 1
d$SRKW[d$J==1|d$K==1|d$L==1]<- 1
d$Orcas<-1
#only data after 1978
d<-d[d$Year>1978,]
#Prepare data for running model from strebel et al 2014
#"nrep" "ndet" "site" "day" "year"
# Add a column for total number of observations
#of all SRKWs during each week of each year year to estimate detection
#d$wkyrfa<-paste(d$Year, d$week,d$FishArea,sep="_")#if we decide to add FishArea to detection estimates for model
#d$wkyr<-paste(d$Year, d$week,sep="_")
#unique(d$FishArea)
d$yrdayfa<-paste(d$Year, d$day,d$FishArea,sep="_")
d<-d[d$FishArea %in% c("01","02","03","04","05","06","07","09","10","11","12","13","81","82"),]#not sure where 17, 18, 19, 20, 28, 29 are...need to find out. also, where is 42583,42584
#add
#Raw detection ratios:
obs = aggregate(Orcas ~yrdayfa, data = d,sum)
# presence of each pod
js = aggregate(J ~yrdayfa, data = d,sum)
ks = aggregate(K~yrdayfa, data = d,sum)
ls = aggregate(L~yrdayfa, data = d,sum)
det<-cbind(js,ks[,2],ls[,2],obs[2])
colnames(det)[2:5]<-c("Jobs","Kobs","Lobs","nrep")
det$year<-substr(det$yrdayfa,1,4)
det$day<-substr(det$yrdayfa,6,8)
det$fa<-substr(det$yrdayfa,10,nchar(det$yrdayfa))
#assign to ps (puget sound) or uss (upper salish sea) using fishing area
det$region<-"ps"
det$region[det$fa=="07"|det$fa=="06"|det$fa=="02"|det$fa=="04"]<-"uss"
det$site<-as.numeric(as.factor(det$fa))
det$day<-as.numeric(det$day)
det$year<-as.numeric(det$year)
head(det
)
head(det)
det
det$site<-as.numeric(as.factor(det$fa))
det$site
