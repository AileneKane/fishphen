mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-4, cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-10, cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-10, adj=1,ex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-10, adj=1,cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-8, adj=1,cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-8, adj=1.5,cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-5, adj=1.2,cex=0.9)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-6, adj=1.3,cex=0.9)
quartz()
par(mai=c(1,1,1,1.5))
#start with uss, all SRKWs
plot(rownames(wdays),wdays$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="All SRKW sightings, 1978-2017", ylim=c(0,200))
lines(rownames(wdays),wdays$ps, lwd=2,lty=2)
lines(rownames(wdays),wdays$oc, lwd=2,lty=3)
legend("topleft",legend=c("Upper Salish Sea","Puget Sound","Outer Coast"), lty=c(1,2,3),col="black", bty="n")
#Is there a treand in number of days on which whales observed since 1978?
#
m.uss<-lm(wdays$uss~as.numeric(rownames(wdays)))
m.ps<-lm(wdays$ps~as.numeric(rownames(wdays)))
m.oc<-lm(wdays$oc~as.numeric(rownames(wdays)))
abline(m.uss, col="darkred", lwd=2)
abline(m.ps, col="darkred", lwd=2, lty=2)
abline(m.oc, col="darkred", lwd=2, lty=3)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-5.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-15.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-25.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-22.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-21.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-20.5, adj=1.3,cex=0.9)
quartz()
par(mai=c(1,1,1,1.5))
#start with uss, all SRKWs
plot(rownames(wdays),wdays$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="All SRKW sightings, 1978-2017", ylim=c(0,200))
lines(rownames(wdays),wdays$ps, lwd=2,lty=2)
lines(rownames(wdays),wdays$oc, lwd=2,lty=3)
legend("topleft",legend=c("Upper Salish Sea","Puget Sound","Outer Coast"), lty=c(1,2,3),col="black", bty="n")
#Is there a treand in number of days on which whales observed since 1978?
#
m.uss<-lm(wdays$uss~as.numeric(rownames(wdays)))
m.ps<-lm(wdays$ps~as.numeric(rownames(wdays)))
m.oc<-lm(wdays$oc~as.numeric(rownames(wdays)))
abline(m.uss, col="darkred", lwd=2)
abline(m.ps, col="darkred", lwd=2, lty=2)
abline(m.oc, col="darkred", lwd=2, lty=3)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-5.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-20.5, adj=1.3,cex=0.9)
mtext(paste((round(m.oc$coef[2], digits=2)*10),"days/dec"), line=-25.5, adj=1.3,cex=0.9)
mtext(paste((round(m.oc$coef[2], digits=2)*10),"days/dec"), line=-22.5, adj=1.3,cex=0.9)
mtext(paste((round(m.oc$coef[2], digits=2)*10),"days/dec"), line=-23.5, adj=1.3,cex=0.9)
quartz()
par(mai=c(1,1,1,1.5))
#start with uss, all SRKWs
plot(rownames(wdays),wdays$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="All SRKW sightings, 1978-2017", ylim=c(0,200))
lines(rownames(wdays),wdays$ps, lwd=2,lty=2)
lines(rownames(wdays),wdays$oc, lwd=2,lty=3)
legend("topleft",legend=c("Upper Salish Sea","Puget Sound","Outer Coast"), lty=c(1,2,3),col="black", bty="n")
#Is there a treand in number of days on which whales observed since 1978?
#
m.uss<-lm(wdays$uss~as.numeric(rownames(wdays)))
m.ps<-lm(wdays$ps~as.numeric(rownames(wdays)))
m.oc<-lm(wdays$oc~as.numeric(rownames(wdays)))
abline(m.uss, col="darkred", lwd=2)
abline(m.ps, col="darkred", lwd=2, lty=2)
abline(m.oc, col="darkred", lwd=2, lty=3)
mtext(paste((round(m.uss$coef[2], digits=2)*10),"days/dec"), line=-5.5, adj=1.3,cex=0.9)
mtext(paste((round(m.ps$coef[2], digits=2)*10),"days/dec"), line=-20.5, adj=1.3,cex=0.9)
mtext(paste((round(m.oc$coef[2], digits=2)*10),"days/dec"), line=-23.5, adj=1.3,cex=0.9)
quartz()
par(mai=c(1,1,1,1.5))
#start with uss, all SRKWs
plot(rownames(wdays),wdays$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="All SRKW sightings, 1978-2017", ylim=c(0,200))
lines(rownames(wdays),wdays$ps, lwd=2,lty=2)
lines(rownames(wdays),wdays$oc, lwd=2,lty=3)
legend("topleft",legend=c("Upper Salish Sea","Puget Sound","Outer Coast"), lty=c(1,2,3),col="black", bty="n")
#Is there a treand in number of days on which whales observed since 1978?
#
m.uss<-lm(wdays$uss~as.numeric(rownames(wdays)))
m.ps<-lm(wdays$ps~as.numeric(rownames(wdays)))
m.oc<-lm(wdays$oc~as.numeric(rownames(wdays)))
abline(m.uss, col="darkred", lwd=2)
abline(m.ps, col="darkred", lwd=2, lty=2)
abline(m.oc, col="darkred", lwd=2, lty=3)
wdays.J<-as.data.frame(tapply(orcasum.days$Jpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.K<-as.data.frame(tapply(orcasum.days$Kpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.L<-as.data.frame(tapply(orcasum.days$Lpres,list(orcasum.days$year,orcasum.days$region),sum))
quartz()
par(mfrow=c(3,1))#par(mfrow)
#J pod
plot(rownames(wdays.J),wdays.J$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="J sightings, 1978-2017", ylim=c(0,200), col="blue")
lines(rownames(wdays.J),wdays.J$ps, lwd=2,lty=2, col="blue")
lines(rownames(wdays.J),wdays.J$oc, lwd=2,lty=3, col="blue")
legend("topleft",legend=c("Upper Salish Sea","Puget Sound","Outer Coast"), lty=c(1,2,3),col="blue", bty="n")
#K
plot(rownames(wdays.K),wdays.K$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="K sightings, 1978-2017", ylim=c(0,200), col="purple")
lines(rownames(wdays.K),wdays.K$ps, lwd=2,lty=2, col="purple")
lines(rownames(wdays.K),wdays.K$oc, lwd=2,lty=3, col="purple")
#L
plot(rownames(wdays.L),wdays.L$uss,type="l",xlab="Year",ylab="Number of whale days", lwd=2,bty="l", main="L sightings, 1978-2017", ylim=c(0,200), col="darkred")
lines(rownames(wdays.L),wdays.L$ps, lwd=2,lty=2, col="darkred")
lines(rownames(wdays.L),wdays.L$oc, lwd=2,lty=3, col="darkred")
#Plotas observed or not by doy and year
#yaxis is year
#xaxis is doy
#do for 3 regions
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
for(p in 1:length(podcols)){
quartz(width=15,height=6)
par(mfrow=c(1,3))
colnum<-which(colnames(orcasum.days)==podcols[p])
regions=unique(orcasum.days$region)
for(r in regions){
regdat<-orcasum.days[orcasum.days$region==r,]
years = unique(orcasum.days$year)
plot(0, type = 'n', las=1, xlim=c(1,366),ylim=c(min(as.numeric(years)),max(as.numeric(years))),ylab="",xlab="DOY", main=paste(r))
for(y in years){
yrdat = regdat[regdat$year==y,]
days = yrdat$day[yrdat[,colnum]==1]
points(x=days,y=rep(y,length=length(days)))
#lines(x=days,y=rep(y,length=length(days)), lwd=2)
}
if(r=="uss"){mtext(paste(pods[p]), side=3,line=2, adj=0.5)}
}
}
wdays
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
for(p in 1:length(podcols)){
quartz(width=15,height=6)
par(mfrow=c(1,3))
colnum<-which(colnames(orcasum.days)==podcols[p])
regions=unique(orcasum.days$region)
for(r in regions){
regdat<-orcasum.days[orcasum.days$region==r,]
if (r=="ps"){
regdat<-regdat[as.numeric(regdat$day)>273,]#look at data only after Sept 30 for PS
}
boxplot(as.numeric(regdat$day)~as.factor(regdat$year),
horizontal=TRUE,las=1,
ylab="year",xlab="DOY",main=paste(r))
if(r=="uss"){mtext(paste(pods[p]), side=3,line=2, adj=0.5)}
}
}
#Add days after sept 30:
orcasum.days$daysaftsept30<-NA
orcasum.days$day<-as.numeric(orcasum.days$day)
orcasum.days$year<-as.numeric(orcasum.days$year)
orcasum.days$daysaftsept30[which(orcasum.days$day>273 & orcasum.days$day<367)]<-orcasum.days$day[which(orcasum.days$day>273 & orcasum.days$day<367)]-273
orcasum.days$daysaftsept30[which(orcasum.days$day<274)]<-orcasum.days$day[which(orcasum.days$day<274)]+93#
#add an "orca year" which runs Oct 1-Sept 31
orcasum.days$orcayear<-orcasum.days$year
orcasum.days$orcayear[which(orcasum.days$day>273)]<-orcasum.days$year[which(orcasum.days$day>273)]+1
orcasum.days
#See if there is a shift in first, last, mean  by decade
regions=unique(orcasum.days$region)
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
years<-unique(orcasum.days$year)
pods.all<-c()
regions=unique(orcasum.days$region)
podcols<-c("Jpres", "Kpres", "Lpres", "AllSRpres")
pods<-c("J","K","L","SRs")
years<-unique(orcasum.days$year)
pods.all<-c()
regions.all<-c()
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
meanest.all<-c()
firstest.sept30.all<-c()
lastest.sept30.all<-c()
meanest.sept30.all<-c()
for(p in 1:length(podcols)){
colnum<-which(colnames(orcasum.days)==podcols[p])
for(r in 1:length(regions)){
regdat<-orcasum.days[orcasum.days$region==regions[r],]
if (regions[r]=="ps"){
regdat<-regdat[as.numeric(regdat$day)>273,]#look at data only after Sept 30 for PS
}
if (regions[r]=="uss"){
regdat<-regdat[as.numeric(regdat$day)<273,]#look at data before Sept 30 for USS
regdat<-regdat[as.numeric(regdat$day)>121,]#look at data after MAy 1 for USS
}
for(y in 1:length(years)){
yrdat<-regdat[regdat$year==years[y],]
pods.all<-c(pods.all,pods[p])
regions.all<-c(regions.all,regions[r])
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat[,colnum]==1]))
firstest.all<-c(firstest.all,min(yrdat$day[yrdat[,colnum]==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat[,colnum]==1], na.rm=TRUE))
meanest.all<-c(meanest.all,mean(as.numeric(yrdat$day[yrdat[,colnum]==1]), na.rm=TRUE))
orcayrdat<-regdat[regdat$orcayear==years[y],]
firstest.sept30.all<-c(firstest.sept30.all,min(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1], na.rm=TRUE))
lastest.sept30.all<-c(lastest.sept30.all,max(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1], na.rm=TRUE))
meanest.sept30.all<-c(meanest.sept30.all,mean(as.numeric(orcayrdat$daysaftsept30[orcayrdat[,colnum]==1]), na.rm=TRUE))
}
}
}
df <- as.data.frame(cbind(pods.all,regions.all,years.all,nobs.all,firstest.all,lastest.all,meanest.all,firstest.sept30.all,lastest.sept30.all,meanest.sept30.all))
colnames(df)<-c("pod","region","year","nobs","firstest","lastest","meanest","firstest.sept30","lastest.sept30","meanest.sept30")
#Now fit some linear models and plots
quartz()
par(mfrow=c(3,4))
pod.df=df[df$pod=="SRs",]
pod.df$firstest[which(pod.df$firstest=="Inf")]<-NA
pod.df$lastest[which(pod.df$lastest=="-Inf")]<-NA
pod.df$firstest<-as.numeric(pod.df$firstest)
pod.df$lastest<-as.numeric(pod.df$lastest)
pod.df$meanest=as.numeric(pod.df$meanest)
pod.df$firstest.sept30[which(pod.df$firstest.sept30=="Inf")]<-NA
pod.df$lastest.sept30[which(pod.df$lastest.sept30=="-Inf")]<-NA
pod.df$duration<-pod.df$lastest-pod.df$firstest
for(i in 1:length(regions)){
reg.df=pod.df[pod.df$region==regions[i],]
reg.df$year=as.numeric(reg.df$year)
#if(regions[i]=="ps" & unique(reg.df$pod)=="SRs"){reg.df<-reg.df[1:40,]}
#if(regions[i]=="uss"& unique(reg.df$pod)=="SRs"){reg.df[81:120,]}
#first obs
plot(reg.df$year,reg.df$firstest,xlab="year",ylab="first obs doy", main=paste(unique(reg.df$pod)), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$firstest~reg.df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#last obs
plot(reg.df$year,reg.df$lastest,xlab="year",ylab="last obs doy", main=paste(regions[i]), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$lastest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#mean obs
plot(reg.df$year,reg.df$meanest,xlab="year",ylab="mean obs doy", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$meanest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#duration
plot(reg.df$year,reg.df$duration,xlab="year",ylab="duration (days)", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$duration~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
abline(mod)
for(i in 1:length(regions)){
reg.df=pod.df[pod.df$region==regions[i],]
reg.df$year=as.numeric(reg.df$year)
#if(regions[i]=="ps" & unique(reg.df$pod)=="SRs"){reg.df<-reg.df[1:40,]}
#if(regions[i]=="uss"& unique(reg.df$pod)=="SRs"){reg.df[81:120,]}
#first obs
plot(reg.df$year,reg.df$firstest,xlab="year",ylab="first obs doy", main=paste(unique(reg.df$pod)), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$firstest~reg.df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#last obs
plot(reg.df$year,reg.df$lastest,xlab="year",ylab="last obs doy", main=paste(regions[i]), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$lastest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#mean obs
plot(reg.df$year,reg.df$meanest,xlab="year",ylab="mean obs doy", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$meanest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#duration
plot(reg.df$year,reg.df$duration,xlab="year",ylab="duration (days)", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$duration~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
abline(mod)
#using days since sept 30 does not change much!
#first obs after sept 30
#plot(reg.df$year,reg.df$firstest.sept30,xlab="year",ylab="first obs day after sept 30", main="all srs", bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$firstest.sept30~reg.df$year)
#abline(mod)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#last obs days after sept 30
#plot(reg.df$year,reg.df$lastest.sept30,xlab="year",ylab="last obs day after sept 30", main=paste(regions[i]), bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$lastest.sept30~reg.df$year)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#abline(mod)
#mean obs
#plot(reg.df$year,reg.df$meanest.sept30,xlab="year",ylab="mean obs day after sept 30", main="", bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$meanest.sept30~reg.df$year)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#abline(mod)
}
#Make boxplots similar to the way that i made them for test data
cbind(df$nobs[df$pod=="SRs"],df$year[df$pod=="SRs"])
pod.df=df[df$pod=="SRs",]
pod.df$firstest[which(pod.df$firstest=="Inf")]<-NA
pod.df$lastest[which(pod.df$lastest=="-Inf")]<-NA
pod.df$firstest<-as.numeric(pod.df$firstest)
pod.df$lastest<-as.numeric(pod.df$lastest)
pod.df$meanest=as.numeric(pod.df$meanest)
pod.df$decade<-"1978-1987"
pod.df$decade[pod.df$year>1987]<-"1988-1997"
pod.df$decade[pod.df$year>1997]<-"1998-2007"
pod.df$decade[pod.df$year>2007]<-"2008-2017"
pod.df$period<-"1978-1997"
pod.df$period[pod.df$year>1997]<-"1998-2017"
quartz()
par(mfrow=c(1,2))
#First obs
boxplot(as.numeric(pod.df$firstest[pod.df$region=="ps"])~as.factor(pod.df$decade[pod.df$region=="ps"]), xlab="Decade", ylab="Estimate of first obs (doy) in PS", main="First obs")
#Last obs
boxplot(as.numeric(pod.df$lastest[pod.df$region=="ps"])~as.factor(pod.df$decade[pod.df$region=="ps"]), xlab="Decade", ylab="Estimate of last obs (doy) in PS", main="Last obs")
quartz()
par(mfrow=c(1,2))
#First obs
boxplot(as.numeric(pod.df$firstest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), xlab="Period", ylab="Estimate of first obs (doy) in PS", main="First obs")
t<-t.test(as.numeric(pod.df$firstest[pod.df$region=="ps"])~pod.df$period[pod.df$region=="ps"], paired = FALSE, var.equal = FALSE,conf.level=0.95)
mtext(paste("Change=",round(t$estimate[1]-t$estimate[2], digits=2),"(",round(t$conf.int[1],digits=2),",",round(t$conf.int[2],digits=2),")", sep=""),side=3,line=-3, adj=1)
#Last obs
boxplot(as.numeric(pod.df$lastest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), xlab="Period", ylab="Estimate of last obs (doy) in PS", main="Last obs")
t<-t.test(as.numeric(pod.df$lastest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), conf.level=0.95)
mtext(paste("Change=",round(t$estimate[1]-t$estimate[2], digits=2),"(",round(t$conf.int[1],digits=2),",",round(t$conf.int[2],digits=2),")", sep=""),side=3,line=-3, adj=1)
quartz()
par(mfrow=c(3,4))
pod.df=df[df$pod=="SRs",]
pod.df$firstest[which(pod.df$firstest=="Inf")]<-NA
pod.df$lastest[which(pod.df$lastest=="-Inf")]<-NA
pod.df$firstest<-as.numeric(pod.df$firstest)
pod.df$lastest<-as.numeric(pod.df$lastest)
pod.df$meanest=as.numeric(pod.df$meanest)
pod.df$firstest.sept30[which(pod.df$firstest.sept30=="Inf")]<-NA
pod.df$lastest.sept30[which(pod.df$lastest.sept30=="-Inf")]<-NA
pod.df$duration<-pod.df$lastest-pod.df$firstest
for(i in 1:length(regions)){
reg.df=pod.df[pod.df$region==regions[i],]
reg.df$year=as.numeric(reg.df$year)
#if(regions[i]=="ps" & unique(reg.df$pod)=="SRs"){reg.df<-reg.df[1:40,]}
#if(regions[i]=="uss"& unique(reg.df$pod)=="SRs"){reg.df[81:120,]}
#first obs
plot(reg.df$year,reg.df$firstest,xlab="year",ylab="first obs doy", main=paste(unique(reg.df$pod)), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$firstest~reg.df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#last obs
plot(reg.df$year,reg.df$lastest,xlab="year",ylab="last obs doy", main=paste(regions[i]), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$lastest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#mean obs
plot(reg.df$year,reg.df$meanest,xlab="year",ylab="mean obs doy", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$meanest~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#duration
plot(reg.df$year,reg.df$duration,xlab="year",ylab="duration (days)", main="", bty="l", pch=21, bg="gray")
mod<-lm(reg.df$duration~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
abline(mod)
#using days since sept 30 does not change much!
#first obs after sept 30
#plot(reg.df$year,reg.df$firstest.sept30,xlab="year",ylab="first obs day after sept 30", main="all srs", bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$firstest.sept30~reg.df$year)
#abline(mod)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#last obs days after sept 30
#plot(reg.df$year,reg.df$lastest.sept30,xlab="year",ylab="last obs day after sept 30", main=paste(regions[i]), bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$lastest.sept30~reg.df$year)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#abline(mod)
#mean obs
#plot(reg.df$year,reg.df$meanest.sept30,xlab="year",ylab="mean obs day after sept 30", main="", bty="l", pch=21, bg="gray")
#mod<-lm(reg.df$meanest.sept30~reg.df$year)
#mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
#abline(mod)
}
runchecker <- function(data, days){
data %>% arrange(date) %>%
group_by(ID) %>%
mutate(diff = c(0, diff(date)),
periodID = 1 + cumsum(diff > days)) %>%
group_by(ID, periodID) %>%
summarise(days = last(date) - first(date))
}
orcasum.days
head(orcasum.days)
##Number of consecutive days
orcasum.days$date <- as.Date(paste(orcasum.days$day,orcasum.days$year), format = "%j")
head(orcasum.days)
strftime(paste(orcasum.days$day,orcasum.days$year), format = "%j")
##Number of consecutive days
orcasum.days$date <- as.Date(paste(orcasum.days$day,orcasum.days$year, sep="-"), format = "%j")
head(orcasum.days)
##Number of consecutive days
orcasum.days$date <- strftime(paste(orcasum.days$day,orcasum.days$year, sep="-"), format = "%j")
##Number of consecutive days
orcasum.days$date <- as.Date(orcasum.days$day,format = "%j", origin = paste("1.1.",orcasum.days$year, sep="."), )
head(orcasum.days)
paste("1.1.",orcasum.days$year, sep=".")
##Number of consecutive days
orcasum.days$date <- as.Date(orcasum.days$day,format = "%j", origin = paste("1.1",orcasum.days$year, sep="."), )
head(orcasum.days)
paste("1.1",orcasum.days$year, sep=".")
##Number of consecutive days
orcasum.days$date <- strptime(paste(orcasum.days$day,orcasum.days$year),format = "%j")
head(orcasum.days)
paste(orcasum.days$day,orcasum.days$year, sep="-")
strptime(paste(orcasum.days$day,orcasum.days$year, sep="-"),format = "%j")
##Number of consecutive days
orcasum.days$doy<- strptime(paste(orcasum.days$day,orcasum.days$year, sep="-"),format = "%j")
orcasum.days$date<-paste(orcasum.days$year,substr(orcasum.days$doy,6,10), sep="-)"
orcasum.days$date<-paste(orcasum.days$year,substr(orcasum.days$doy,6,10), sep="-")
orcasum.days$date
head(orcasum.days)
doy<- strptime(paste(orcasum.days$day,orcasum.days$year, sep="-"),format = "%j")
orcasum.days$date<-paste(orcasum.days$year,substr(doy,6,10), sep="-")
runchecker <- function(data, days){
data %>% arrange(date) %>%
group_by(ID) %>%
mutate(diff = c(0, diff(date)),
periodID = 1 + cumsum(diff > days)) %>%
group_by(ID, periodID) %>%
summarise(days = last(date) - first(date))
}
orcaobs.days<-subset(orcasum.days, select=c(region,AllSRpres,date))
runchecker <- function(data, days){
data %>% arrange(date) %>%
group_by(AllSRpres) %>%
mutate(diff = c(0, diff(date)),
periodID = 1 + cumsum(diff > days)) %>%
group_by(ID, periodID) %>%
summarise(days = last(date) - first(date))
}
podcols
p=4
colnum<-which(colnames(orcasum.days)==podcols[p])
regions=unique(orcasum.days$region)
regions
r=1
r="ps"
regdat<-orcasum.days[orcasum.days$region==r,]
orcaobs.<-subset(regdat, select=c(AllSRpres,date))
orcaobs
orcaobs<-subset(regdat, select=c(AllSRpres,date))
orcaobs
head(orcaobs)
consec<-runchecker(orcaobs$AllSRpres,orcaobs$date)
as.Date(orcaobs$date)
consec<-runchecker(orcaobs$AllSRpres,as.Date(orcaobs$date))
is.data.frame(orcaobs)
head(orcaobs)
runchecker(orcaobs,1)
runchecker(orcaobs,5)
head(orcaobs)
diff(date)
diff = c(0, diff(orcobs$date)
)
diff = c(0, diff(orcaobs$date))
is.date(orcaobs$date)
is.Date(orcaobs$date)
as.Date(orcaobs$date)
df <- orcaobs[order(orcaobs$region,orcaobs$date),]
df <- orcasum.days[order(orcasum.days$region,orcasum.days$date),]
dim(df)
df <- df[!duplicated(df[,c("region","date")]),]
dim(df)
df$last_Date <- c(as.Date("1978-01-01",format="%Y-%m-%d"),df[1:nrow(df)-1,]$Date)
df$last_Date <- c(as.Date("1978-01-01",format="%Y-%m-%d"),df[1:nrow(df)-1,]$date)
head(df)
tail(df)
nrow(df)
df[1:nrow(df)-1,]
df[1:nrow(df)-1,]$date
df$last_Date <- c(as.Date("1979-08-16 ",format="%Y-%m-%d"),df[1:nrow(df)-1,]$date)
head(df)
df[1:nrow(df)-1,]$date
length(df[1:nrow(df)-1,]$date)
head(df)
df$last_Date <- df$date
head(df)
df[1:nrow(df)-1,]df$date
df[1:nrow(df)-1,]
df[1:nrow(df)-1,]$date
c(as.Date("1979-08-16 ",format="%Y-%m-%d"),df[1:nrow(df)-1,]$date)
c("1979-08-16 ",df[1:nrow(df)-1,]$date)
df$last_Date <- c("1979-08-16 ",df[1:nrow(df)-1,]$date)
df$diff <- df$Date - df$last_Date
df$last_Date <- as.Date(c("1979-08-16 ",df[1:nrow(df)-1,]$date))
df$diff <- df$Date - df$last_Date
df$Date <- as.Date(df$date)
df$diff <- df$Date - df$last_Date
head(df)
df$diff <- df$Date - df$last_Date
df$last_region <- c(0,df[1:nrow(df)-1,]$region)
df$diff_region <- ifelse(df$region == df$last_region,0,1)
df$flag <- ifelse(df$diff==1 & df$diff_region==0,0,1)
consecutive_count <- function(x)  {
x <- !x
rl <- rle(x)
len <- rl$lengths
v <- rl$values
cumLen <- cumsum(len)
z <- x
# replace the 0 at the end of each zero-block in z by the
# negative of the length of the preceding 1-block....
iDrops <- c(0, diff(v)) < 0
z[ cumLen[ iDrops ] ] <- -len[ c(iDrops[-1],FALSE) ]
# ... to ensure that the cumsum below does the right thing.
# We zap the cumsum with x so only the cumsums for the 1-blocks survive:
x*cumsum(z)
}
df$Consecutive <- consecutive_count(df$flag)
