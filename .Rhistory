d$LikelyPod[d$LikelyPod=="KL "|d$LikelyPod=="KL  "]<-"KL"
d$LikelyPod[d$LikelyPod=="SR"|d$LikelyPod=="sRs"|d$LikelyPod=="S"]<-"SRs"
d$LikelyPod[d$LikelyPod=="T"|d$LikelyPod=="Ts "]<-"Ts"
#dim(d)
#3. Clean source column
unique(d$Source)
d$Source[d$Source=="SPOT "|d$Source=="SPOT   "]<-"SPOT"
#4. Clean Year column
d$Year[d$Year==0]<-2001
#5. Clean the FishArea column and format them to match the WDFW rec data formatting
d$FishArea[d$FishArea=="1"]<-"01"
d$FishArea[d$FishArea=="2"]<-"02"
d$FishArea[d$FishArea=="3"]<-"03"
d$FishArea[d$FishArea=="4"]<-"04"
d$FishArea[d$FishArea=="5"]<-"05"
d$FishArea[d$FishArea=="6"]<-"06"
d$FishArea[d$FishArea=="7"]<-"07"
d$FishArea[d$FishArea=="8"]<-"08"
d$FishArea[d$FishArea=="9"]<-"09"
d$FishArea[d$FishArea=="8-1"|d$FishArea=="8.1"]<-"81"
d$FishArea[d$FishArea=="8-2"|d$FishArea=="8.2"]<-"82"
d$FishArea[d$FishArea=="17"]<-"17C"
d$FishArea[d$FishArea=="18"]<-"18C"
d$FishArea[d$FishArea=="20"]<-"20C"
d$FishArea[d$FishArea=="28"]<-"28C"
d$FishArea[d$FishArea=="29"]<-"29C"
d$FishArea[d$FishArea=="121A"]<-"121C"
#6. Clean Long and Convert quad data to FishArea and Lat Long
d$Long[which(as.numeric(d$Long)>0)]<-as.numeric(d$Long[which(as.numeric(d$Long)>0)])*-1
quads<-quads[,1:6]
#format "quads" to match orcamaster database above
quads$Fish.Area[quads$Fish.Area==5.0]<-"05"
quads$Fish.Area[quads$Fish.Area==6.0]<-"06"
quads$Fish.Area[quads$Fish.Area==7.0]<-"07"
quads$Fish.Area[quads$Fish.Area==8.1]<-"81"
quads$Fish.Area[quads$Fish.Area==8.2]<-"82"
quads$Fish.Area[quads$Fish.Area==9.0]<-"09"
quads$Fish.Area[quads$Fish.Area==10.0]<-"10"
quads$Fish.Area[quads$Fish.Area==11.0]<-"11"
quads$Fish.Area[quads$Fish.Area==12.0]<-"12"
quads$Fish.Area[quads$Fish.Area==13.0]<-"13"
quads$Fish.Area[quads$Fish.Area==14.0]<-"14C"
quads$Fish.Area[quads$Fish.Area==17.0]<-"17C"
quads$Fish.Area[quads$Fish.Area==18.0]<-"18C"
quads$Fish.Area[quads$Fish.Area==19.0]<-"19C"
quads$Fish.Area[quads$Fish.Area==20.0]<-"20C"
quads$Fish.Area[quads$Fish.Area==28.0]<-"28C"
quads$Fish.Area[quads$Fish.Area==29.0]<-"29C"
#for sightings with quad area but no fisharea, add in fisharea
#check which sites with no fisharea have a quadrant
#sort(unique(d$Quadrant[d$FishArea==""|d$FishArea=="<Null>"]))
#length(d$Quadrant[d$FishArea==""|d$FishArea=="<Null>"])#728
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="110"]<-quads$Fish.Area[quads$Quad==110]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="112"]<-quads$Fish.Area[quads$Quad==112]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="113"]<-quads$Fish.Area[quads$Quad==113]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="122"]<-quads$Fish.Area[quads$Quad==122]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="124"]<-quads$Fish.Area[quads$Quad==124]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="136"]<-quads$Fish.Area[quads$Quad==136]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="141"]<-quads$Fish.Area[quads$Quad==141]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="164"]<-quads$Fish.Area[quads$Quad==164]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="170"]<-quads$Fish.Area[quads$Quad==170]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="175"]<-quads$Fish.Area[quads$Quad==175]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="176"]<-quads$Fish.Area[quads$Quad==176]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="181"]<-quads$Fish.Area[quads$Quad==181]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="182"]<-quads$Fish.Area[quads$Quad==182]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="20"]<-quads$Fish.Area[quads$Quad==20]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="226"]<-quads$Fish.Area[quads$Quad==226]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="227"]<-quads$Fish.Area[quads$Quad==227]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="228"]<-quads$Fish.Area[quads$Quad==228]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="229"]<-quads$Fish.Area[quads$Quad==229]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="232"]<-quads$Fish.Area[quads$Quad==232]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="237"]<-quads$Fish.Area[quads$Quad==237]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="238"]<-quads$Fish.Area[quads$Quad==238]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="240"]<-quads$Fish.Area[quads$Quad==240]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="241"]<-quads$Fish.Area[quads$Quad==241]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="258"]<-quads$Fish.Area[quads$Quad==258]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="317"]<-quads$Fish.Area[quads$Quad==317]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="43"]<-quads$Fish.Area[quads$Quad==43]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="62"]<-quads$Fish.Area[quads$Quad==62]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="64"]<-quads$Fish.Area[quads$Quad==64]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="65"]<-quads$Fish.Area[quads$Quad==65]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="67"]<-quads$Fish.Area[quads$Quad==67]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="76"]<-quads$Fish.Area[quads$Quad==76]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="77"]<-quads$Fish.Area[quads$Quad==77]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="80"]<-quads$Fish.Area[quads$Quad==80]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="81"]<-quads$Fish.Area[quads$Quad==81]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="95"]<-quads$Fish.Area[quads$Quad==95]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="96"]<-quads$Fish.Area[quads$Quad==96]
d$FishArea[d$FishArea==""|d$FishArea=="<Null>"& d$Quadrant=="97"]<-quads$Fish.Area[quads$Quad==97]
#d$Quadrant[which(is.na(d$FishArea))]#all="" so can't be added
#some sights have fishareas of 42583 or 42584 which don't make sense, but quadrant does make sense. Fix these
d$FishArea[d$FishArea=="42583" & d$Quadrant=="366"]<-quads$Fish.Area[quads$Quad==366]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="372"]<-quads$Fish.Area[quads$Quad==372]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="373"]<-quads$Fish.Area[quads$Quad==373]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="374"]<-quads$Fish.Area[quads$Quad==374]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="375"]<-quads$Fish.Area[quads$Quad==375]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="379"]<-quads$Fish.Area[quads$Quad==379]
d$FishArea[d$FishArea=="42583" & d$Quadrant=="380"]<-quads$Fish.Area[quads$Quad==380]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="378"]<-quads$Fish.Area[quads$Quad==378]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="381"]<-quads$Fish.Area[quads$Quad==381]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="383"]<-quads$Fish.Area[quads$Quad==383]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="384"]<-quads$Fish.Area[quads$Quad==384]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="385"]<-quads$Fish.Area[quads$Quad==385]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="386"]<-quads$Fish.Area[quads$Quad==386]
d$FishArea[d$FishArea=="42584" & d$Quadrant=="398"]<-quads$Fish.Area[quads$Quad==398]
#Remove non-orca data- removed this because more absence data might be good!
#d<-d[d$LikelyPod!="HB?"|d$LikelyPod!="Not Orcas",]
###Are there any sites that hace qudrant but no lat long?
#unique(d$Quadrant[which(is.na(as.numeric(d$Lat)))])
#YES! Add these
d$Lat[d$Lat=="" & d$Quadrant=="20"]<-quads$Lat[quads$Quad==20]
d$Long[d$Long=="" & d$Quadrant=="20"]<-quads$Long[quads$Quad==20]
d$Lat[d$Lat=="" & d$Quadrant=="401"]<-quads$Lat[quads$Quad==401]
d$Long[d$Long=="" & d$Quadrant=="401"]<-quads$Long[quads$Quad==401]
d$Lat[d$Lat=="" & d$Quadrant=="167"]<-quads$Lat[quads$Quad==167]
d$Long[d$Long=="" & d$Quadrant=="167"]<-quads$Long[quads$Quad==167]
d$Lat[d$Lat=="" & d$Quadrant=="412"]<-quads$Lat[quads$Quad==412]
d$Long[d$Long=="" & d$Quadrant=="412"]<-quads$Long[quads$Quad==412]
unique(d$Quadrant[d$FishArea=="07"])
sort(unique(d$Quadrant[d$FishArea=="07"]))
range(as.numeric(d$Long[d$FishArea == "07"]), na.rm=TRUE)
range(as.numeric(d$Lat[d$FishArea == "07"]), na.rm=TRUE)
range(d$Lat, na.rm=TRUE)
range(as.numerc(d$Lat), na.rm=TRUE)
range(as.numeric(d$Lat), na.rm=TRUE)
range(as.numeric(d$Long), na.rm=TRUE)
newmap <- getMap(resolution = "low")
quartz(height=12, width=6)
plot(newmap, xlim = c(-126, -120), ylim = c(47.2, 51), asp = 1)
quartz(height=12, width=6)
plot(newmap, xlim = c(-126, -120), ylim = c(48.2, 51), asp = 1)
d$Lat<-as.numeric(d$Lat);d$Long<-as.numeric(d$Long)
points((d$Long[d$FishArea=="07],d$Lat[d$FishArea=="07], type="p",och=16, col="green")
points(d$Long[d$FishArea=="07"],d$Lat[d$FishArea=="07"], type="p",och=16, col="green")
#d$Lat<-as.numeric(d$Lat);d$Long<-as.numeric(d$Long)
#points(d$Long[d$FishArea=="07"],d$Lat[d$FishArea=="07"], type="p",och=16, col="green")
points(d$Long[d$FishArea=="06"],d$Lat[d$FishArea=="06"], type="p",och=16, col="blue")
#Only use fishing areas that have atleast 4 years with >20 observations:
#Look at some basic stats about orca observations
#Started with orca_dataprep_occmodel.R code
#4 February 2019
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
#or from laptop:
#setwd("/Users/aileneettinger/Documents/GitHub/fishphen")
# Load libraries
library(dplyr)
library(mgcv)
library(scales)
library(RColorBrewer)
library(rworldmap)
library(scales)
library(matrixStats)
# 1. Choose the years, regions of interest, assumption about reports in the OrcaMaster and get the data
includeCanada=TRUE
firstyear=1976#probably set to 1975 or 1976 (Olson et al)
assumeSRKW=TRUE #If true, assume that "Orcas" means SRKW unless noted otherwuse (i.e. Transients or NRKWs)
use3regions=TRUE#If true, separate out the straight of Juan de Fuca as a 3rd region, distinct from CSS and PS
d <- read.csv("data/AppendixII.csv")
quads<-read.csv("data/QuadCentroids.csv")
dim(d)#105344     18 on August 8, 2019
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/orcaphen/source/clean_orca.R")
dim(d)#105339     21 on August 8, 2019
#d$Lat<-as.numeric(d$Lat);d$Long<-as.numeric(d$Long)
#points(d$Long[d$FishArea=="07"],d$Lat[d$FishArea=="07"], type="p",och=16, col="green")
points(d$Long[d$FishArea=="06"],d$Lat[d$FishArea=="06"], type="p",och=16, col="blue")
points(d$Long[d$FishArea=="06"],d$Lat[d$FishArea=="06"], type="p",och=16, col="blue")
points(d$Long[d$FishArea=="05"],d$Lat[d$FishArea=="05"], type="p",col="red")
points(d$Long[d$FishArea=="04"],d$Lat[d$FishArea=="04"], type="p",col="orange")
points(d$Long[d$FishArea=="03"],d$Lat[d$FishArea=="03"], type="p",col="yellow")
points(d$Long[d$FishArea=="02"],d$Lat[d$FishArea=="02"], type="p",col="yellow")
points(d$Long[d$FishArea=="01"],d$Lat[d$FishArea=="01"], type="p",col="yellow")
points(d$Long[d$FishArea=="09"],d$Lat[d$FishArea=="09"], type="p",col="purple")
points(d$Long[d$FishArea=="81"],d$Lat[d$FishArea=="82"], type="p",col="gray")
points(d$Long[d$FishArea=="81"],d$Lat[d$FishArea=="81"], type="p",col="gray")
points(d$Long[d$FishArea=="82"],d$Lat[d$FishArea=="82"], type="p",col="gray")
points(d$Long[d$FishArea=="12"],d$Lat[d$FishArea=="12"], type="p",col="lightblue")
points(d$Long[d$FishArea=="11"],d$Lat[d$FishArea=="11"], type="p",col="lightgreen")
points(d$Long[d$FishArea=="13"],d$Lat[d$FishArea=="13"], type="p",col="darkgreen")
points(d$Long[d$FishArea=="10"],d$Lat[d$FishArea=="10"], type="p",col="pink")
points(d$Long[d$FishArea=="18C"],d$Lat[d$FishArea=="18C"], type="p",col="lightgreen")
points(d$Long[d$FishArea=="19C"],d$Lat[d$FishArea=="19C"], type="p",col="darkred")
points(d$Long[d$FishArea=="20C"],d$Lat[d$FishArea=="20C"], type="p",col="pink")
points(d$Long[d$FishArea=="21C"],d$Lat[d$FishArea=="21C"], type="p",col="lilac")
points(d$Long[d$FishArea=="21C"],d$Lat[d$FishArea=="21C"], type="p",col="lightpurple")
points(d$Long[d$FishArea=="21C"],d$Lat[d$FishArea=="21C"], type="p",col="purple")
points(d$Long[d$FishArea=="121C"],d$Lat[d$FishArea=="121C"], type="p",col="purple")
points(d$Long[d$FishArea=="122C"],d$Lat[d$FishArea=="122C"], type="p",col="purple")
d$Lat[d$FishArea=="122C"]
d$Long[d$FishArea=="21C"]
d$Quadrant[d$FishArea=="21C"]
#Run simple linear models on srkw data
years<-seq(1978,2017, by=1)#restrict to these years for orcayears
#Look at trends in SRKW phenology across all years, for all pods
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
for(y in 1:length(years)){
yrdat<-orcasum.days[orcasum.days$orcayear==years[y],]
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat$AllSRobs==1]))
firstest.all<-c(firstest.all,min(yrdat$daysaftapr30[yrdat$AllSRobs==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat$AllSRobs==1], na.rm=TRUE))
}
df <- as.data.frame(cbind(years.all,nobs.all,firstest.all,lastest.all))
colnames(df)[1:2]<-c("year","nobs")
plot(df$year,df$firstest.all,xlab="year",ylab="first obs doy", main="", bty="l", pch=21, bg="gray")
mod<-lm(df$firstest.all~df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
plot(df$year,df$lastest.all,xlab="year",ylab="last obs doy", main="", bty="l", pch=21, bg="gray")
mod<-lm(df$lastest.all~df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#Create dataframe with first, last obs for each start date in each year
pods.all<-c()
regions.all<-c()
years.all<-c()
nobs.all<-c()
#firstest.1may.all<-c()#for uss
#firstest.1oct.all<-c()#for ps
#lastest.31oct.all<-c()#for uss
#lastest.31jan.all<-c()#for ps
firstest.all<-c()
lastest.all<-c()
#p=1
#r=1
#unique(orcasum.days$orcayear)#use may 1 as start of orca year, as this will encompass min start date window that i want to try
for(p in 1:length(podcols)){
colnum<-which(colnames(orcasum.days)==podcols[p])
for(r in 1:2){
regdat<-orcasum.days[orcasum.days$region==regions[r],]
if (regions[r]=="uss"){
regdat<-regdat[as.numeric(regdat$daysaftapr30)<185,]#may 1 through sept 30 for summer season
}
if (regions[r]=="ps"){
regdat<-regdat[as.numeric(regdat$daysaftapr30)>=154 &as.numeric(regdat$daysaftapr30)<277,]#include data oct 1 through jan 31
}
for(y in 1:length(years)){
yrdat<-regdat[regdat$orcayear==years[y],]
pods.all<-c(pods.all,pods[p])
regions.all<-c(regions.all,regions[r])
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat[,colnum]==1]))
#      if (regions[r]=="uss"){
#firstest.1may.all<-c(firstest.1may.all,min(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))#1may=1 day after apr30stdays
#lastest.31oct.all<-c(lastest.31oct.all,max(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))#31oct= 184 days after apr30
#firstest.1oct.all<-c(firstest.1oct.all,NA)
#lastest.31jan.all<-c(lastest.31jan.all,NA)
#       }
#      if (regions[r]=="ps"){
#       firstest.1oct.all<-c(firstest.1oct.all,min(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))}
#        lastest.31jan.all<-c(lastest.31jan.all,max(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))
#       firstest.1may.all<-c(firstest.1may.all,NA)
#      lastest.31oct.all<-c(lastest.31oct.all,NA)
#     }
firstest.all<-c(firstest.all,min(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$daysaftapr30[yrdat[,colnum]==1], na.rm=TRUE))
}
}
}
df <- as.data.frame(cbind(pods.all,regions.all,years.all,nobs.all,firstest.all,lastest.all))
colnames(df)[1:4]<-c("pod","region","year","nobs")
#Plot trends using different start and end dates
pod.df=df[df$pod=="SRs",]
pod.df$firstest.all[which(pod.df$firstest.all=="Inf")]<-NA
pod.df$lastest.all[which(pod.df$lastest.all=="-Inf")]<-NA
#
pod.df$firstest.all<-as.numeric(pod.df$firstest.all)
pod.df$lastest.all<-as.numeric(pod.df$lastest.all)
pod.df$year<-as.numeric(pod.df$year)
quartz(height=6,width=7)
par(mfrow=c(2,2))
for(r in 1:2){
reg.df<-pod.df[pod.df$region==regions[r],]
#first obs
plot(reg.df$year,reg.df$firstest.all,xlab="year",ylab="first obs doy", main=paste(regions[r]), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$firstest.all~reg.df$year)
abline(mod)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
#last obs
plot(reg.df$year,reg.df$lastest.all,xlab="year",ylab="last obs doy", main=paste(regions[r]), bty="l", pch=21, bg="gray")
mod<-lm(reg.df$lastest.all~reg.df$year)
mtext(paste("r2=",round(summary(mod)$r.squared, digits=2),",p=",round(summary(mod)$coeff[2,4], digits=2)), side=3, adj=1, cex=0.7)
abline(mod)
print(summary(mod))
mtext(paste("coef=",round(summary(mod)$coeff[2,1], digits=2)), side=3,line=-1, adj=1, cex=0.7)
}
#Linear models don't make sense given the data- look like nonlinear relationships
#Make boxplots similar to the way that i made them for test data
pod.df=df[df$pod=="SRs",]
pod.df$firstest[which(pod.df$firstest=="Inf")]<-NA
pod.df$lastest[which(pod.df$lastest=="-Inf")]<-NA
pod.df$firstest<-as.numeric(pod.df$firstest)
pod.df$lastest<-as.numeric(pod.df$lastest)
pod.df$decade<-"1977-1986"
pod.df$decade[pod.df$year>1986]<-"1987-1996"
pod.df$decade[pod.df$year>1996]<-"1997-2006"
pod.df$decade[pod.df$year>2006]<-"2007-2016"
pod.df$period<-"1978-1997"
pod.df$period[pod.df$year>1997]<-"1998-2017"
quartz()
par(mfrow=c(1,2))
#First obs
boxplot(as.numeric(pod.df$firstest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), xlab="Period", ylab="Estimate of first obs (doy) in PS", main="First obs")
first.t.ps<-t.test(as.numeric(pod.df$firstest[pod.df$region=="ps"])~pod.df$period[pod.df$region=="ps"], paired = FALSE, var.equal = FALSE,conf.level=0.95)
#mtext(paste("Change=",-1*round(t$estimate[1]-t$estimate[2], digits=1),"(",-1*round(t$conf.int[1],digits=1),",",-1*round(t$conf.int[2],digits=1),")", sep=""),side=3,line=-3, adj=1)
#Last obs
boxplot(as.numeric(pod.df$lastest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), xlab="Period", ylab="Estimate of last obs (doy) in PS", main="Last obs")
last.t.ps<-t.test(as.numeric(pod.df$lastest[pod.df$region=="ps"])~as.factor(pod.df$period[pod.df$region=="ps"]), conf.level=0.95)
#mtext(paste("Change=",-1*round(t$estimate[1]-t$estimate[2], digits=1),"(",-1*round(t$conf.int[1],digits=1),",",-1*round(t$conf.int[2],digits=1),")", sep=""),side=1,line=-3, adj=1)
#create a vector with the differences, like in the simulation code:
firstdif.ps<-first.t.ps$estimate[2]-first.t.ps$estimate[1]
firstdifp.ps<-first.t.ps$p.value
lastdif.ps<-last.t.ps$estimate[2]-last.t.ps$estimate[1]
lastdifp.ps<-last.t.ps$p.value
quartz()
par(mfrow=c(1,2))
#First obs
boxplot(as.numeric(pod.df$firstest[pod.df$region=="uss"])~as.factor(pod.df$period[pod.df$region=="uss"]), xlab="Period", ylab="Estimate of first obs (doy) in USS", main="First obs")
first.t.uss<-t.test(as.numeric(pod.df$firstest[pod.df$region=="uss"])~pod.df$period[pod.df$region=="uss"], paired = FALSE, var.equal = FALSE,conf.level=0.95)
#mtext(paste("Change=",-1*round(t$estimate[1]-t$estimate[2], digits=1),"(",-1*round(t$conf.int[1],digits=1),",",-1*round(t$conf.int[2],digits=1),")", sep=""),side=3,line=-3, adj=1)
#Last obs
boxplot(as.numeric(pod.df$lastest[pod.df$region=="uss"])~as.factor(pod.df$period[pod.df$region=="uss"]), xlab="Period", ylab="Estimate of last obs (doy) in USS", main="Last obs")
last.t.uss<-t.test(as.numeric(pod.df$lastest[pod.df$region=="uss"])~as.factor(pod.df$period[pod.df$region=="uss"]), conf.level=0.95)
#mtext(paste("Change=",-1*round(t$estimate[1]-t$estimate[2], digits=1),"(",-1*round(t$conf.int[1],digits=1),",",-1*round(t$conf.int[2],digits=1),")", sep=""),side=1,line=-3, adj=1)
#create a vector with the differences, like in the simulation code:
firstdif.uss<-first.t.uss$estimate[2]-first.t.uss$estimate[1]
firstdifp.uss<-first.t.uss$p.value
lastdif.uss<-last.t.uss$estimate[2]-last.t.uss$estimate[1]
lastdifp.uss<-last.t.uss$p.value
change.df<-as.data.frame(rbind(c("SRs","ps",mean(as.numeric(pod.df$nobs[pod.df$region=="ps"], na.rm=TRUE)),NA,firstdif.ps,firstdifp.ps,lastdif.ps,lastdifp.ps),
c("SRs","uss",mean(as.numeric(pod.df$nobs[pod.df$region=="uss"], na.rm=TRUE)),NA,firstdif.uss,firstdifp.uss,lastdif.uss,lastdifp.uss)))
colnames(change.df)<-c("pod","region","nobs","prob","first.dif","first.p","last.dif","last.p")
#Run simple linear models on srkw data
years<-seq(1978,2017, by=1)#restrict to these years for orcayears
#Look at trends in SRKW phenology across all years, for all pods
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
for(y in 1:length(years)){
yrdat<-orcasum.days[orcasum.days$orcayear==years[y],]
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat$AllSRobs==1]))
firstest.all<-c(firstest.all,min(yrdat$daysaftapr30[yrdat$AllSRobs==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat$AllSRobs==1], na.rm=TRUE))
}
#Only use fishing areas that have atleast 4 years with >20 observations:
#Look at some basic stats about orca observations
#Started with orca_dataprep_occmodel.R code
#4 February 2019
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
#or from laptop:
#setwd("/Users/aileneettinger/Documents/GitHub/fishphen")
# Load libraries
library(dplyr)
library(mgcv)
library(scales)
library(RColorBrewer)
library(rworldmap)
library(scales)
library(matrixStats)
# 1. Choose the years, regions of interest, assumption about reports in the OrcaMaster and get the data
includeCanada=TRUE
firstyear=1976#probably set to 1975 or 1976 (Olson et al)
assumeSRKW=TRUE #If true, assume that "Orcas" means SRKW unless noted otherwuse (i.e. Transients or NRKWs)
use3regions=TRUE#If true, separate out the straight of Juan de Fuca as a 3rd region, distinct from CSS and PS
d <- read.csv("data/AppendixII.csv")
quads<-read.csv("data/QuadCentroids.csv")
dim(d)#105344     18 on August 8, 2019
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/orcaphen/source/clean_orca.R")
dim(d)#105339     21 on August 8, 2019
# 3. Limit space and time to firstyear or later and Salish Sea, Puget Sound, Washington Outer Coast
source("analyses/orcaphen/source/orca_limitspacetime.R")
dim(d)#103289     22
#table(d$FishArea,d$region)#check regions are correct
#4. Get data in terms of number of observations per day and "whale days": days on which whales were seen (presence/absence for each day)
source("analyses/orcaphen/source/orca_get_whaledays.R")
#5. Summarize and plot whale days
wdays<-as.data.frame(tapply(orcasum.days$AllSRpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.J<-as.data.frame(tapply(orcasum.days$Jpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.K<-as.data.frame(tapply(orcasum.days$Kpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.L<-as.data.frame(tapply(orcasum.days$Lpres,list(orcasum.days$year,orcasum.days$region),sum))
source("analyses/orcaphen/source/orca_plot_whaledays.R")
#6. if you want to do some other basic plots of the data. This includes proportion of days in a week in which whales were observed up by week and decade
#source("analyses/orcaphen/source/orca_plotdata.R")
#7. Make a map of the SRKW sightings in ps and uss
source("analyses/orcaphen/source/orca_makemap.R")
#Take home from the above plots: Seasonality is hard to see in the figure with a separate line for each decade. I also plotted them with a single line showing the mean across all decades, and I standardized the proportions by substracting the means and dividing by the standard deviation.
#I did this to try to make seasonal patterns more obvious. It only sort of made them more obvious. Here's what I take away from these figures:
#1) There is a very clear seasonal pattern in the SRKW use of the upper salish sea. This season ranges roughly from week 20 (mid May) through week 40 (early October).
#2) The seasonal pattern in the SRKW use is less obvious for Puget Sound, because the maximum proportion is lower over all. However, the season during which the proportion is consistently above the mean probability
#ranges from week 40 (early October) through week 2 (early January)
#use these for whale seasons to investigate shifts over time
#use apr 1 for uss season, aug 1 for ps season as start dates
#use oct 31 for uss season, jan31 for ps season, as end dates
#Only use fishing areas that have atleast 4 years with >20 observations:
#Look at some basic stats about orca observations
#Started with orca_dataprep_occmodel.R code
#4 February 2019
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
#or from laptop:
#setwd("/Users/aileneettinger/Documents/GitHub/fishphen")
# Load libraries
library(dplyr)
library(mgcv)
library(scales)
library(RColorBrewer)
library(rworldmap)
library(scales)
library(matrixStats)
# 1. Choose the years, regions of interest, assumption about reports in the OrcaMaster and get the data
includeCanada=TRUE
firstyear=1976#probably set to 1975 or 1976 (Olson et al)
assumeSRKW=TRUE #If true, assume that "Orcas" means SRKW unless noted otherwuse (i.e. Transients or NRKWs)
use3regions=FALSE#If true, separate out the straight of Juan de Fuca as a 3rd region, distinct from CSS and PS
d <- read.csv("data/AppendixII.csv")
quads<-read.csv("data/QuadCentroids.csv")
dim(d)#105344     18 on August 8, 2019
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/orcaphen/source/clean_orca.R")
dim(d)#105339     21 on August 8, 2019
# 3. Limit space and time to firstyear or later and Salish Sea, Puget Sound, Washington Outer Coast
source("analyses/orcaphen/source/orca_limitspacetime.R")
dim(d)#103289     22
#table(d$FishArea,d$region)#check regions are correct
#4. Get data in terms of number of observations per day and "whale days": days on which whales were seen (presence/absence for each day)
source("analyses/orcaphen/source/orca_get_whaledays.R")
#5. Summarize and plot whale days
wdays<-as.data.frame(tapply(orcasum.days$AllSRpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.J<-as.data.frame(tapply(orcasum.days$Jpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.K<-as.data.frame(tapply(orcasum.days$Kpres,list(orcasum.days$year,orcasum.days$region),sum))
wdays.L<-as.data.frame(tapply(orcasum.days$Lpres,list(orcasum.days$year,orcasum.days$region),sum))
source("analyses/orcaphen/source/orca_plot_whaledays.R")
#6. if you want to do some other basic plots of the data. This includes proportion of days in a week in which whales were observed up by week and decade
#source("analyses/orcaphen/source/orca_plotdata.R")
#7. Make a map of the SRKW sightings in ps and uss
source("analyses/orcaphen/source/orca_makemap.R")
#8. Fit some basic linear models to all srkw data
regions=unique(orcasum.days$region)
podcols<-c("Jpres","Kpres","Lpres","AllSRpres")
pods<-c("J", "K","L","SRs")
source("analyses/orcaphen/source/orca_runlinmods.R")
#Run simple linear models on srkw data
years<-seq(1978,2017, by=1)#restrict to these years for orcayears
#Look at trends in SRKW phenology across all years, for all pods
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
for(y in 1:length(years)){
yrdat<-orcasum.days[orcasum.days$orcayear==years[y],]
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat$AllSRobs==1]))
firstest.all<-c(firstest.all,min(yrdat$daysaftapr30[yrdat$AllSRobs==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat$AllSRobs==1], na.rm=TRUE))
}
warnings()
df <- as.data.frame(cbind(years.all,nobs.all,firstest.all,lastest.all))
colnames(df)[1:2]<-c("year","nobs")
plot(df$year,df$firstest.all,xlab="year",ylab="first obs doy", main="", bty="l", pch=21, bg="gray")
lastest.all
firstest.all
yrdat$daysaftapr30[yrdat$AllSRobs==1]
yrdat
min(yrdat$daysaftapr30[yrdat$AllSRobs==1], na.rm=TRUE)
yrdat$daysaftapr30[yrdat$AllSRobs==1]
#Look at trends in SRKW phenology across all years, for all pods
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
for(y in 1:length(years)){
yrdat<-orcasum.days[orcasum.days$orcayear==years[y],]
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat$AllSRobs==1]))
firstest.all<-c(firstest.all,min(yrdat$ddaysaftmar31[yrdat$AllSRobs==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat$AllSRobs==1], na.rm=TRUE))
}
firstest.all
#Look at trends in SRKW phenology across all years, for all pods
years.all<-c()
nobs.all<-c()
firstest.all<-c()
lastest.all<-c()
for(y in 1:length(years)){
yrdat<-orcasum.days[orcasum.days$orcayear==years[y],]
years.all<-c(years.all,years[y])
nobs.all<-c(nobs.all,length(yrdat$day[yrdat$AllSRobs==1]))
firstest.all<-c(firstest.all,min(yrdat$daysaftmar31[yrdat$AllSRobs==1], na.rm=TRUE))
lastest.all<-c(lastest.all,max(yrdat$day[yrdat$AllSRobs==1], na.rm=TRUE))
}
df <- as.data.frame(cbind(years.all,nobs.all,firstest.all,lastest.all))
df
