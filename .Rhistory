}
}
",fill = TRUE)
sink()
### Read observation data from Acrocephalus arundinaceus
dat<-read.csv("analyses/output/j_dat.csv",header=T)
#for starters, run on most recent 7 years only:
dat<-dat[dat$year>2010,]
### The following procedure is based on the models presented in Crainiceanu et al. 2005 and in Gimenez et al. 2006
# Degree of splines
degree <- 2
# covariate
covariate<-as.numeric(scale(range(dat$day)[1]:range(dat$day)[2]))
# covariate length
n <- length(covariate)
# location of knots
nk<-round((max(dat$day)-min(dat$day)+1)/4)
nknots<-ifelse(nk<35,nk,35)
knots<-quantile(unique(covariate),seq(0,1,length=(nknots+2))[-c(1,(nknots+2))])
# fixed effects matrix
X<-NULL
for (l in 0:degree) {
X<-cbind(X,covariate^l)
}
# random coefficients matrix
Z_K<-(abs(outer(covariate,knots,"-")))^3
OMEGA_all<-(abs(outer(knots,knots,"-")))^3
svd.OMEGA_all<-svd(OMEGA_all)
sqrt.OMEGA_all<-t(svd.OMEGA_all$v %*% (t(svd.OMEGA_all$u)*sqrt(svd.OMEGA_all$d)))
Z<-t(solve(sqrt.OMEGA_all,t(Z_K)))
# Input data
site <- dat$site
survey <- dat$day-min(dat$day)+1
nobs <- length(unique(paste(dat$site,dat$day,dat$year)))
nrep <- dat$nrep
nsite <- length(unique(dat$site))
nyear <- length(unique(dat$year))
year <- as.numeric(factor(dat$year))
zst <- array(1, dim=c(nsite,nyear))
y <- dat$ndet
# Simulation parameters
ni=1000; nc=2; nb=10; nt=50
# List input data
jags.data <- list("site","survey","nobs","nrep","nsite","nyear","year","nknots","n","X","Z","nc", "nb", "ni", "nt","zst","y")
head(jags.data)
jags.data$site
names(jags.data)
# List input data
jags.data <- list("site","survey","nobs","nrep","nsite","nyear","year","nknots","n","X","Z","nc", "nb", "ni", "nt","zst","y")
jags.data$site
site
length(site)
length(survey)
length(nobs)
length(unique(paste(dat$site,dat$day,dat$year)))
nobs <- length(unique(paste(dat$site,dat$day,dat$year)))
nobs
nrep <- dat$nrep
nrep
nsite
length(unique(dat$site))
nyear <- length(unique(dat$year))
nyear
year <- as.numeric(factor(dat$year))
year
zst
# Specify model in BUGS language
sink("splinesSiteOcc S4.txt")
cat("
model {
### Define seasonal and annual patterns in detectability
for (m in 1:nyear) {
for (i in 1:n) {
logit(p[m,i]) <- lp[m,i]
lp[m,i] <- mfe[m,i]+mre[m,i]
mfe[m,i] <- a[m]*X[i,1]+b[m]*X[i,2]+c[m]*X[i,3]
mre[m,i]<-sum(n.mre[m,i,1:nknots])
for (k in 1:nknots) {
n.mre[m,i,k]<-b.k[m,k]*Z[i,k]
}
}
### Random regression coefficients corresponding to the truncated polynomial functions
for (k in 1:nknots) {
b.k[m,k] ~ dnorm(0,taub)
}
### Fixed regression coefficients corresponding to the 'plus' functions
a[m] ~ dnorm(0,0.01)
b[m] ~ dnorm(0,0.01)
c[m] ~ dnorm(0,0.01)
}
### precision for random regression coefficients corresponding to the truncated polynomial functions
taub~dgamma(1.0E-6,1.0E-6)
# Specify priors
for (k in 1:nyear) {
psi[k] ~ dunif(0, 1)
}
# Ecological submodel: Define state conditional on parameters
for (i in 1:nsite){
for (k in 1:nyear){
z[i,k] ~ dbern(psi[k])
}
}
# Observation model
for (i in 1:nobs){
muy[site[i],survey[i],year[i]] <- z[site[i],year[i]]*p[year[i],survey[i]]
y[i] ~ dbin(muy[site[i],survey[i],year[i]], nrep[i])
}
}
",fill = TRUE)
sink()
### Read observation data from Acrocephalus arundinaceus
dat<-read.table(file="dat S4.txt",header=T)
getwd()
### Read observation data from Acrocephalus arundinaceus
dat<-read.table(file="analyses/dat S4.txt",header=T)
unique(dat$nrep)
# Orca analysis: occupancy models
# Started November 1327, 2018
# by Ailene Ettinger ailene.ettinger@noo.gov
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
# Load libraries
# 1. Get the data
d <- read.csv("data/AppendixII.csv")
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/clean_orca.R")
#Create a new column that combines Pod and Likely Pod columna and removes spaces
d$Pod.cl<-d$Pod
#Always use Likely Pod column, when it is not blank:
d$Pod.cl[d$LikelyPod!="" & d$LikelyPod!=" "]<-d$LikelyPod[d$LikelyPod!="" & d$LikelyPod!=" "]
#perhaps also stick with Pod when LikelyPod has a "?" grep("?",d$LikelyPod,)
#remove non-orca data
d<-d[d$Pod.cl!="HB?"|d$Pod.cl!="Not Orcas",]
#Add week and day of year (day)
d$day<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"),format= "%j")
d$week<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"), format = "%V")#new weeks start on mondays
#Add a column for presences (1/0) for each pod, for Ts, and for SRKWs
d$J<-0
d$J[grep("J",d$Pod.cl)]<- 1
d$K<-0
d$K[grep("K",d$Pod.cl)]<- 1
d$L<-0
d$L[grep("L",d$Pod.cl)]<- 1
d$SRKW<-0
d$SRKW[grep("SR",d$Pod.cl)]<- 1
d$SRKW[d$J==1|d$K==1|d$L==1]<- 1
d$Orcas<-1
# Restrict analysis to only SRKWs (pods J,K,L)
#d<-d[d$SRKW==1,]#do not do this for now- perhaps this will  reduce the number of "perfect detections"?
#only data after 1978
d<-d[d$Year>1978,]
#Prepare data for running model from strebel et al 2014
#"nrep" "ndet" "site" "day" "year"
# Add a column for total number of observations
#of all SRKWs during each week of each year year to estimate detection
#d$wkyrfa<-paste(d$Year, d$week,d$FishArea,sep="_")#if we decide to add FishArea to detection estimates for model
#d$wkyr<-paste(d$Year, d$week,sep="_")
d$yrdayfa<-paste(d$Year, d$day,d$FishArea,sep="_")
#Raw detection ratios:
obs = aggregate(Orcas ~yrdayfa, data = d,sum)
# presence of each pod
js = aggregate(J ~yrdayfa, data = d,sum)
ks = aggregate(K~yrdayfa, data = d,sum)
ls = aggregate(L~yrdayfa, data = d,sum)
det<-cbind(js,ks[,2],ls[,2],obs[2])
colnames(det)[2:5]<-c("Jobs","Kobs","Lobs","nrep")
det$year<-substr(det$yrdayfa,1,4)
det$day<-substr(det$yrdayfa,6,8)
det$site<-substr(det$yrdayfa,10,nchar(det$yrdayfa))
det$site<-as.numeric(as.factor(det$site))
det$day<-as.numeric(det$day)
det$year<-as.numeric(det$year)
jdet<-subset(det,select=c(nrep,Jobs,site,day,year))
#remove any rows with 0s in them
#i.e. use only sites that have atleast 1 observation in all years
jdet <- jdet[apply(jdet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
#jdet<- jdet[apply(jdet,1,function(row) all(row!=0)),]
kdet<-subset(det,select=c(nrep,Kobs,site,day,year))
kdet <- kdet[apply(kdet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
ldet<-subset(det,select=c(nrep,Lobs,site,day,year))
ldet <- ldet[apply(ldet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
colnames(jdet)[2]<-colnames(kdet)[2]<-colnames(ldet)[2]<-"ndet"
write.csv(ldet,"analyses/output/l_dat.csv",row.names = FALSE)
write.csv(kdet,"analyses/output/k_dat.csv",row.names = FALSE)
write.csv(jdet,"analyses/output/j_dat.csv",row.names = FALSE)
### Read observation data from Acrocephalus arundinaceus
jdat<-read.csv("analyses/output/j_dat.csv",header=T)
unique(jdat$nrep)
site <- dat$site
### Read observation data from Acrocephalus arundinaceus
dat<-read.table(file="analyses/dat S4.txt",header=T)
### The following procedure is based on the models presented in Crainiceanu et al. 2005 and in Gimenez et al. 2006
# Degree of splines
degree <- 2
# covariate
covariate<-as.numeric(scale(range(dat$day)[1]:range(dat$day)[2]))
# covariate length
n <- length(covariate)
# location of knots
nk<-round((max(dat$day)-min(dat$day)+1)/4)
nknots<-ifelse(nk<35,nk,35)
knots<-quantile(unique(covariate),seq(0,1,length=(nknots+2))[-c(1,(nknots+2))])
# fixed effects matrix
X<-NULL
for (l in 0:degree) {
X<-cbind(X,covariate^l)
}
# random coefficients matrix
Z_K<-(abs(outer(covariate,knots,"-")))^3
OMEGA_all<-(abs(outer(knots,knots,"-")))^3
svd.OMEGA_all<-svd(OMEGA_all)
sqrt.OMEGA_all<-t(svd.OMEGA_all$v %*% (t(svd.OMEGA_all$u)*sqrt(svd.OMEGA_all$d)))
Z<-t(solve(sqrt.OMEGA_all,t(Z_K)))
# Input data
site <- dat$site
survey <- dat$day-min(dat$day)+1
dat$day-min(dat$day)+1
nobs <- length(unique(paste(dat$site,dat$day,dat$year)))
nobs
nrep <- dat$nrep
nrep
nsite <- length(unique(dat$site))
nyear <- length(unique(dat$year))
year <- as.numeric(factor(dat$year))
zst <- array(1, dim=c(nsite,nyear))
y <- dat$ndet
y
unique(y)
jy <- dat$ndet
jy <- jdat$ndet
jy
unique(jy)
sort(unique(jy))
unique(y)
nyear
nsite
# Worked example to run the model presented in Strebel et al., 2014
#   (Study of phenology by flexible estimation and modeling of seasonal detectability peaks)
# Author:  Nicolas Strebel, nicolas_strebel@gmx.ch
# Date:	4.2.2014
# Title:	Run model
##################################################################
#-----------------------------------------------------------------
# Codes prepare data and run the analysis
#-----------------------------------------------------------------
### Set working directory
setwd("~/Documents/GitHub/fishphen")
# Specify model in BUGS language
sink("splinesSiteOcc S4.txt")
cat("
model {
### Define seasonal and annual patterns in detectability
for (m in 1:nyear) {
for (i in 1:n) {
logit(p[m,i]) <- lp[m,i]
lp[m,i] <- mfe[m,i]+mre[m,i]
mfe[m,i] <- a[m]*X[i,1]+b[m]*X[i,2]+c[m]*X[i,3]
mre[m,i]<-sum(n.mre[m,i,1:nknots])
for (k in 1:nknots) {
n.mre[m,i,k]<-b.k[m,k]*Z[i,k]
}
}
### Random regression coefficients corresponding to the truncated polynomial functions
for (k in 1:nknots) {
b.k[m,k] ~ dnorm(0,taub)
}
### Fixed regression coefficients corresponding to the 'plus' functions
a[m] ~ dnorm(0,0.01)
b[m] ~ dnorm(0,0.01)
c[m] ~ dnorm(0,0.01)
}
### precision for random regression coefficients corresponding to the truncated polynomial functions
taub~dgamma(1.0E-6,1.0E-6)
# Specify priors
for (k in 1:nyear) {
psi[k] ~ dunif(0, 1)
}
# Ecological submodel: Define state conditional on parameters
for (i in 1:nsite){
for (k in 1:nyear){
z[i,k] ~ dbern(psi[k])
}
}
# Observation model
for (i in 1:nobs){
muy[site[i],survey[i],year[i]] <- z[site[i],year[i]]*p[year[i],survey[i]]
y[i] ~ dbin(muy[site[i],survey[i],year[i]], nrep[i])
}
}
",fill = TRUE)
sink()
### Read observation data from Acrocephalus arundinaceus
dat<-read.table(file="analyses/dat S4.txt",header=T)
### The following procedure is based on the models presented in Crainiceanu et al. 2005 and in Gimenez et al. 2006
# Degree of splines
degree <- 2
# covariate
covariate<-as.numeric(scale(range(dat$day)[1]:range(dat$day)[2]))
# covariate length
n <- length(covariate)
# location of knots
nk<-round((max(dat$day)-min(dat$day)+1)/4)
nknots<-ifelse(nk<35,nk,35)
knots<-quantile(unique(covariate),seq(0,1,length=(nknots+2))[-c(1,(nknots+2))])
# fixed effects matrix
X<-NULL
for (l in 0:degree) {
X<-cbind(X,covariate^l)
}
# random coefficients matrix
Z_K<-(abs(outer(covariate,knots,"-")))^3
OMEGA_all<-(abs(outer(knots,knots,"-")))^3
svd.OMEGA_all<-svd(OMEGA_all)
sqrt.OMEGA_all<-t(svd.OMEGA_all$v %*% (t(svd.OMEGA_all$u)*sqrt(svd.OMEGA_all$d)))
Z<-t(solve(sqrt.OMEGA_all,t(Z_K)))
# Input data
site <- dat$site
survey <- dat$day-min(dat$day)+1
nobs <- length(unique(paste(dat$site,dat$day,dat$year)))
nrep <- dat$nrep
nsite <- length(unique(dat$site))
nyear <- length(unique(dat$year))
year <- as.numeric(factor(dat$year))
zst <- array(1, dim=c(nsite,nyear))
y <- dat$ndet
# Simulation parameters
ni=10000; nc=2; nb=25000; nt=50
# List input data
jags.data <- list("site","survey","nobs","nrep","nsite","nyear","year","nknots","n","X","Z","nc", "nb", "ni", "nt","zst","y")
# Inits function
f.inits <- function(){list(a=rep(0,nyear), b=rep(0,nyear), c=rep(0,nyear), z=zst)}
# specify the parameters to be monitored
parameters <- c("a","b","c","b.k","lp","psi","taub")
### Run MCMC Analysis using jags
library(R2jags)
jags.out<-jags.parallel(jags.data,f.inits,parameters,"splinesSiteOcc S4.txt",nc,ni,nb,nt)
dat$day
min(dat$day)
min(dat$day)+1
survey
unique(survey)
min(dat$day)
# Orca analysis: occupancy models
# Started November 1327, 2018
# by Ailene Ettinger ailene.ettinger@noo.gov
#housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
# Set working directory:
setwd("~/Documents/GitHub/fishphen")
# Load libraries
# 1. Get the data
d <- read.csv("data/AppendixII.csv")
# 2. Clean the data (also saved in output/AppendixII_cleaned,csv)
source("analyses/clean_orca.R")
#Create a new column that combines Pod and Likely Pod columna and removes spaces
d$Pod.cl<-d$Pod
#Always use Likely Pod column, when it is not blank:
d$Pod.cl[d$LikelyPod!="" & d$LikelyPod!=" "]<-d$LikelyPod[d$LikelyPod!="" & d$LikelyPod!=" "]
#perhaps also stick with Pod when LikelyPod has a "?" grep("?",d$LikelyPod,)
#remove non-orca data
d<-d[d$Pod.cl!="HB?"|d$Pod.cl!="Not Orcas",]
#Add week and day of year (day)
d$day<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"),format= "%j")
d$week<-strftime(strptime(paste(d$Month, d$Day, d$Year, sep="."),format= "%m.%d.%Y"), format = "%V")#new weeks start on mondays
#Add a column for presences (1/0) for each pod, for Ts, and for SRKWs
d$J<-0
d$J[grep("J",d$Pod.cl)]<- 1
d$K<-0
d$K[grep("K",d$Pod.cl)]<- 1
d$L<-0
d$L[grep("L",d$Pod.cl)]<- 1
d$SRKW<-0
d$SRKW[grep("SR",d$Pod.cl)]<- 1
d$SRKW[d$J==1|d$K==1|d$L==1]<- 1
d$Orcas<-1
# Restrict analysis to only SRKWs (pods J,K,L)
#d<-d[d$SRKW==1,]#do not do this for now- perhaps this will  reduce the number of "perfect detections"?
#only data after 1978
d<-d[d$Year>1978,]
#Prepare data for running model from strebel et al 2014
#"nrep" "ndet" "site" "day" "year"
# Add a column for total number of observations
#of all SRKWs during each week of each year year to estimate detection
#d$wkyrfa<-paste(d$Year, d$week,d$FishArea,sep="_")#if we decide to add FishArea to detection estimates for model
#d$wkyr<-paste(d$Year, d$week,sep="_")
d$yrdayfa<-paste(d$Year, d$day,d$FishArea,sep="_")
#Raw detection ratios:
obs = aggregate(Orcas ~yrdayfa, data = d,sum)
# presence of each pod
js = aggregate(J ~yrdayfa, data = d,sum)
ks = aggregate(K~yrdayfa, data = d,sum)
ls = aggregate(L~yrdayfa, data = d,sum)
det<-cbind(js,ks[,2],ls[,2],obs[2])
colnames(det)[2:5]<-c("Jobs","Kobs","Lobs","nrep")
det$year<-substr(det$yrdayfa,1,4)
det$day<-substr(det$yrdayfa,6,8)
det$site<-substr(det$yrdayfa,10,nchar(det$yrdayfa))
det$site<-as.numeric(as.factor(det$site))
det$day<-as.numeric(det$day)
det$year<-as.numeric(det$year)
jdet<-subset(det,select=c(nrep,Jobs,site,day,year))
#remove any rows with 0s in them
#i.e. use only sites that have atleast 1 observation in all years
jdet <- jdet[apply(jdet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
#jdet<- jdet[apply(jdet,1,function(row) all(row!=0)),]
kdet<-subset(det,select=c(nrep,Kobs,site,day,year))
kdet <- kdet[apply(kdet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
ldet<-subset(det,select=c(nrep,Lobs,site,day,year))
ldet <- ldet[apply(ldet, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
colnames(jdet)[2]<-colnames(kdet)[2]<-colnames(ldet)[2]<-"ndet"
#i coudn't run model code, perhaps because some years have no observations?
#rowSums(table(jdet$site,jdet$year))#There are data in all years and all sites
#or maybe because there are 366 days in the year?
#jdet$day[jdet$day==366]<-365
write.csv(ldet,"analyses/output/l_dat.csv",row.names = FALSE)
write.csv(kdet,"analyses/output/k_dat.csv",row.names = FALSE)
write.csv(jdet,"analyses/output/j_dat.csv",row.names = FALSE)
#   (Study of phenology by flexible estimation and modeling of seasonal detectability peaks)
# Author: Ailene Ettinger, ailene.ettinger@noaa.gov
# (Original Author of worked example:  Nicolas Strebel, nicolas_strebel@gmx.ch
# Date:	Novrmber 27, 2018
# Title:	orca_run_models4
##################################################################
#-----------------------------------------------------------------
# Codes prepare data and run the analysis
#-----------------------------------------------------------------
### Set working directory
setwd("~/Documents/GitHub/fishphen")
# Specify model in BUGS language
sink("analyses/splinesSiteOcc S4.txt")
cat("
model {
### Define seasonal and annual patterns in detectability
for (m in 1:nyear) {
for (i in 1:n) {
logit(p[m,i]) <- lp[m,i]
lp[m,i] <- mfe[m,i]+mre[m,i]
mfe[m,i] <- a[m]*X[i,1]+b[m]*X[i,2]+c[m]*X[i,3]
mre[m,i]<-sum(n.mre[m,i,1:nknots])
for (k in 1:nknots) {
n.mre[m,i,k]<-b.k[m,k]*Z[i,k]
}
}
### Random regression coefficients corresponding to the truncated polynomial functions
for (k in 1:nknots) {
b.k[m,k] ~ dnorm(0,taub)
}
### Fixed regression coefficients corresponding to the 'plus' functions
a[m] ~ dnorm(0,0.01)
b[m] ~ dnorm(0,0.01)
c[m] ~ dnorm(0,0.01)
}
### precision for random regression coefficients corresponding to the truncated polynomial functions
taub~dgamma(1.0E-6,1.0E-6)
# Specify priors
for (k in 1:nyear) {
psi[k] ~ dunif(0, 1)
}
# Ecological submodel: Define state conditional on parameters
for (i in 1:nsite){
for (k in 1:nyear){
z[i,k] ~ dbern(psi[k])
}
}
# Observation model
for (i in 1:nobs){
muy[site[i],survey[i],year[i]] <- z[site[i],year[i]]*p[year[i],survey[i]]
y[i] ~ dbin(muy[site[i],survey[i],year[i]], nrep[i])
}
}
",fill = TRUE)
### Read observation data from Acrocephalus arundinaceus
dat<-read.csv("analyses/output/k_dat.csv",header=T)
#for starters, run on most recent 7 years only:
dat<-dat[dat$year>2010,]
### The following procedure is based on the models presented in Crainiceanu et al. 2005 and in Gimenez et al. 2006
# Degree of splines
degree <- 2
# covariate
covariate<-as.numeric(scale(range(dat$day)[1]:range(dat$day)[2]))
# covariate length
n <- length(covariate)
# location of knots
nk<-round((max(dat$day)-min(dat$day)+1)/4)
nknots<-ifelse(nk<35,nk,35)
knots<-quantile(unique(covariate),seq(0,1,length=(nknots+2))[-c(1,(nknots+2))])
# fixed effects matrix
X<-NULL
for (l in 0:degree) {
X<-cbind(X,covariate^l)
}
# random coefficients matrix
Z_K<-(abs(outer(covariate,knots,"-")))^3
OMEGA_all<-(abs(outer(knots,knots,"-")))^3
svd.OMEGA_all<-svd(OMEGA_all)
sqrt.OMEGA_all<-t(svd.OMEGA_all$v %*% (t(svd.OMEGA_all$u)*sqrt(svd.OMEGA_all$d)))
Z<-t(solve(sqrt.OMEGA_all,t(Z_K)))
# Input data
site <- dat$site
survey <- dat$day-min(dat$day)+1
survey
min(dat$day)
min(dat$day)
'.sv'
;,wD ;
,]P
3
3+5
